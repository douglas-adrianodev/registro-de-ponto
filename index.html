<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaranaTime Cloud - Gest√£o Total</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS (DARK TECH THEME) --- */
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --input-bg: #334155;
            --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155;
            --primary: #0ea5e9; --primary-dark: #0284c7; --secondary: #6366f1;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --glow: 0 0 20px rgba(14, 165, 233, 0.3);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        html, body { height: 100%; width: 100%; background: var(--bg); color: var(--text); overflow: hidden; font-size: 14px; }
        .app-container { height: 100%; width: 100%; max-width: 1400px; margin: 0 auto; display: flex; flex-direction: column; padding: 10px; position: relative; }
        
        /* Header */
        .main-header { text-align: center; margin-bottom: 5px; flex-shrink: 0; position: relative; z-index: 10; }
        .logo-area h1 { color: var(--primary); font-size: 1.5rem; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .status-bar { font-size: 0.7rem; font-weight: bold; margin-top: 2px; display: flex; justify-content: center; gap: 8px; }
        .status-item { padding: 2px 8px; border-radius: 10px; background: var(--input-bg); color: var(--text-muted); border: 1px solid var(--border); white-space: nowrap; }
        .status-item.online { background: rgba(16, 185, 129, 0.2); color: #34d399; border-color: var(--success); }
        
        /* Nav */
        .nav-bar { display: flex; gap: 8px; margin-bottom: 10px; background: var(--card-bg); padding: 5px; border-radius: 12px; flex-shrink: 0; border: 1px solid var(--border); }
        .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-muted); border-radius: 8px; transition: 0.2s; white-space: nowrap; }
        .nav-btn.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; box-shadow: var(--glow); }

        /* Content */
        .view-section { display: none; flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; padding-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .view-section.active { display: flex; flex-direction: column; }
        #view-ponto.active { align-items: center; justify-content: center; }
        
        /* Cards */
        .card { background: var(--card-bg); padding: 15px; border-radius: 16px; border: 1px solid var(--border); width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #view-admin .card { max-width: 100%; display: block; }
        
        /* Camera */
        .camera-wrapper { position: relative; margin-bottom: 15px; padding: 4px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); width: min(280px, 60vw); height: min(280px, 60vw); flex-shrink: 0; box-shadow: var(--glow); }
        .camera-container { position: relative; width: 100%; height: 100%; background: #000; border-radius: 50%; overflow: hidden; mask-image: radial-gradient(white, black); -webkit-mask-image: -webkit-radial-gradient(white, black); border: 2px solid #000; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.9; }
        #ai-overlay { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; transform: scaleX(-1); }
        .face-mold { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60%; height: 75%; border: 2px dashed rgba(255, 255, 255, 0.3); border-radius: 55% 55% 45% 45%; pointer-events: none; z-index: 5; }
        .scanner-laser { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--primary); box-shadow: 0 0 10px var(--primary); opacity: 0.8; animation: scanDown 2s ease-in-out infinite; z-index: 6; pointer-events: none; }
        @keyframes scanDown { 0%,100% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* Inputs */
        .input-group { margin-bottom: 10px; width: 100%; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: var(--input-bg); color: white; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        #employee-name-display { background-color: rgba(14, 165, 233, 0.1); color: var(--primary); border-color: var(--primary); font-weight: bold; text-align: center; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 5px rgba(14, 165, 233, 0.5); }
        input[readonly] { cursor: default; }

        /* Buttons */
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; font-size: 0.95rem; width: 100%; padding: 12px; display: flex; justify-content: center; align-items: center; gap: 5px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; }
        .btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); width: auto; }
        .btn-success { background: #059669; color: white; width: auto; }
        .btn-danger { background: #dc2626; color: white; width: auto; }
        .btn-purple { background: #7c3aed; color: white; width: auto; }
        .btn-edit { background: #d97706; color: white; padding: 4px 8px; font-size: 0.75rem; width: auto; }
        .btn-warning { background: #f59e0b; color: #000; width: auto; }

        /* Admin Layout */
        .filters-area, .input-group.admin-panel { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .filter-item { flex: 1 1 140px; }
        .form-row { display: grid; gap: 10px; margin-top: 10px; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); align-items: end; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .kpi-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 5px 0; }
        .kpi-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .chart-container { height: 250px; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; margin-bottom: 15px; }

        /* Tabela */
        .table-responsive { overflow-x: auto; margin-top: 10px; max-height: 400px; overflow-y: auto; border-radius: 8px; border: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 800px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; color: var(--text-muted); }
        th { background: #1e293b; position: sticky; top: 0; z-index: 10; color: var(--text); }
        td { color: #cbd5e1; }
        tr.irregular td { color: #fca5a5; background: rgba(239, 68, 68, 0.1); }
        tr.abonado td { color: #86efac; background: rgba(34, 197, 94, 0.1); }

        /* Clock */
        .system-clock { position: absolute; top: 10px; right: 10px; text-align: right; z-index: 100; pointer-events: none; font-family: monospace; }
        .digital-time { font-size: 1.2rem; font-weight: bold; color: var(--success); text-shadow: 0 0 5px rgba(57, 255, 20, 0.5); }
        .digital-date { font-size: 0.65rem; color: var(--success); opacity: 0.8; text-transform: uppercase; }

        /* Modals & Feedback */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); padding: 10px; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-card { background: var(--card-bg); padding: 25px; border-radius: 16px; width: 100%; max-width: 500px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        
        #success-message, #error-message { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 15px 30px; border-radius: 50px; z-index: 20; font-weight: bold; animation: popIn 0.4s; }
        #success-message { background: rgba(16, 185, 129, 0.95); color: white; }
        #error-message { background: rgba(220, 38, 38, 0.95); color: white; }
        
        .modal-card.error-style { border-color: var(--danger); background: #3f1010; }
        .modal-card.error-style h3 { color: #fca5a5; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -40%) scale(0.8); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @media(max-width: 900px) { .form-row { grid-template-columns: 1fr; } .filter-row { flex-direction: column; gap: 10px; } .filter-item, .filter-item-large { width: 100%; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="system-clock"><div class="digital-time" id="digital-time">00:00</div><div class="digital-date" id="digital-date">--</div></div>

    <header class="main-header">
        <div class="logo-area"><h1>‚òÅÔ∏è MaranaTime</h1><p>Gest√£o Total</p></div>
        <div class="status-bar"><span id="ia-status" class="status-item">IA: ...</span><span id="db-status" class="status-item">Conectando...</span></div>
    </header>

    <nav class="nav-bar">
        <button onclick="window.app.switchTab('ponto')" id="btn-ponto" class="nav-btn active">üïí Ponto</button>
        <button onclick="window.app.switchTab('admin')" id="btn-admin" class="nav-btn">üõ†Ô∏è Gest√£o</button>
    </nav>

    <!-- PONTO -->
    <section id="view-ponto" class="view-section active">
        <div class="card">
            <div class="camera-wrapper">
                <div class="camera-container">
                    <video id="video-feed" autoplay playsinline muted></video>
                    <canvas id="ai-overlay"></canvas>
                    <div class="face-mold"></div>
                    <div class="scanner-laser"></div>
                    <div id="success-message">‚úÖ <span id="success-text">OK</span></div>
                    <div id="error-message">‚ö†Ô∏è <span id="error-text">Erro</span></div>
                </div>
            </div>
            <div class="input-group">
                <label>üë§ Colaborador Identificado</label>
                <input type="text" id="employee-name-display" placeholder="Aguardando..." readonly>
                <input type="hidden" id="employee-id">
            </div>
            <div class="input-group">
                <label>üìå A√ß√£o</label>
                <select id="punch-type" style="text-align: center;">
                    <option value="Entrada">üü¢ Registrar Entrada</option>
                    <option value="Sa√≠da Almo√ßo">üçΩÔ∏è Sa√≠da Almo√ßo</option>
                    <option value="Volta Almo√ßo">üîô Volta Almo√ßo</option>
                    <option value="Fim Expediente">üî¥ Encerrar Expediente</option>
                </select>
            </div>
        </div>
    </section>

    <!-- GEST√ÉO -->
    <section id="view-admin" class="view-section">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Painel Administrativo</h2>
                <button onclick="window.app.logoutAdmin()" class="btn-danger small">üîí Sair</button>
            </div>

            <!-- DASHBOARD ANALYTICS -->
            <div class="filters-area" style="border-color: var(--primary);">
                <label style="font-weight: bold; color: var(--primary);">üìä Indicadores Individuais</label>
                <div class="filter-row" style="margin-top: 10px;">
                     <div class="filter-item"><label>Colaborador:</label><select id="dashboard-employee-select" onchange="window.app.atualizarDashboard()"><option value="">Selecione...</option></select></div>
                     <div class="filter-item"><label>M√™s:</label><input type="month" id="dashboard-month" onchange="window.app.atualizarDashboard()"></div>
                </div>
                <div class="dashboard-grid" style="margin-top: 20px;">
                    <div class="kpi-card"><div class="kpi-label">Saldo</div><div class="kpi-value" id="kpi-balance">--</div></div>
                    <div class="kpi-card"><div class="kpi-label">Dias Trab.</div><div class="kpi-value" id="kpi-days">0</div></div>
                    <div class="kpi-card"><div class="kpi-label">Pontualidade</div><div class="kpi-value" id="kpi-punctuality">--%</div></div>
                </div>
                <div class="chart-container"><canvas id="attendanceChart"></canvas></div>
            </div>

            <!-- CADASTRO -->
            <div class="input-group admin-panel">
                <h3 style="color: var(--primary); font-size: 1rem;">üë§ Novo Cadastro</h3>
                <div class="form-row">
                    <div><label>ID</label><input type="number" id="new-user-id"></div>
                    <div><label>Nome</label><input type="text" id="new-user-name"></div>
                    <div><label>Unidade</label><select id="new-user-unit"><option value="">...</option></select></div>
                </div>
                <div class="form-row">
                     <div><label>Regime</label><select id="new-user-scale"><option value="comum">Comum</option><option value="12x36">12x36</option></select></div>
                    <div><label>Hrs/Sem</label><input type="number" id="new-user-hours" value="44"></div>
                </div>
                <div class="form-row" style="margin-top: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <div><label>Entrada</label><input type="time" id="new-user-start"></div>
                    <div><label>Pausa (min)</label><input type="number" id="new-user-break" placeholder="60"></div>
                    <div><label>Sa√≠da</label><input type="time" id="new-user-end"></div>
                </div>
                <div class="camera-container" style="height: 120px; width: 120px; margin: 10px auto 0; border: 2px solid var(--primary);"> 
                    <video id="admin-video-feed" autoplay playsinline muted style="transform: none; object-fit: cover;"></video>
                </div>
                <button onclick="window.app.cadastrarBiometria()" class="btn-primary" style="margin-top: 10px;">üì∏ Salvar Cadastro</button>
            </div>

            <!-- LOCAIS -->
            <div class="input-group admin-panel">
                <h3 style="color: #34d399; font-size: 1rem;">üìç Unidades</h3>
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div><label>Nome</label><input type="text" id="loc-name"></div>
                    <div><label>CNPJ</label><input type="text" id="loc-cnpj"></div>
                    <div><label>Endere√ßo</label><input type="text" id="loc-address"></div>
                </div>
                <div class="form-row">
                    <div><label>CEP</label><input type="text" id="loc-cep"></div>
                    <div><label>N¬∫</label><input type="text" id="loc-num"></div>
                    <div style="display:flex; align-items:end;"><button onclick="window.app.buscarCoordenadas()" class="btn-secondary">üîç GPS</button></div>
                </div>
                <input type="hidden" id="loc-lat"><input type="hidden" id="loc-lon">
                <button onclick="window.app.salvarLocal()" class="btn-success" style="margin-top: 10px;">Salvar Unidade</button>
                <div id="lista-locais" style="max-height: 100px; overflow-y: auto; margin-top: 10px; font-size: 0.8rem;"></div>
            </div>

            <!-- RELAT√ìRIOS -->
            <div class="filters-area">
                <label style="font-weight:bold; color: var(--primary);">Relat√≥rios:</label>
                <div class="filter-row" style="margin-top:10px;">
                    <div class="filter-item"><label>M√™s:</label><input type="month" id="admin-month-filter"></div>
                    <div class="filter-item"><label>Unidade:</label><select id="admin-unit-filter"><option value="">Todas</option></select></div>
                    <div class="filter-item"><button onclick="window.app.carregarTabelaPontos()" class="btn-secondary" style="margin-top:23px;">Atualizar Lista</button></div>
                </div>
                <div class="actions-row">
                    <button onclick="window.app.imprimirRelatorioDetalhado()" class="btn-success">üñ®Ô∏è Extrato Detalhado</button>
                    <button onclick="window.app.imprimirRelatorioFechamento()" class="btn-purple">üìä Fechamento da Unidade</button>
                </div>
            </div>

            <!-- HIST√ìRICO COM JUSTIFICATIVA -->
            <div class="logs-area">
                <h3 style="font-size: 1rem; margin-bottom: 10px;">Acompanhamento Di√°rio (M√™s Atual)</h3>
                <div class="table-responsive">
                    <table id="logs-table">
                        <thead><tr><th>Data</th><th>Hora</th><th>Colaborador</th><th>Tipo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="logs-tbody"></tbody>
                    </table>
                </div>
                <p style="font-size: 0.75rem; color: #fca5a5; margin-top: 5px;">* Linhas vermelhas indicam diverg√™ncia de hor√°rio.</p>
            </div>
        </div>
    </section>
</div>

<!-- MODAIS -->
<div id="modal-login" class="modal-overlay"><div class="modal-card"><h3>üîí Login</h3><div class="input-group"><label>Usu√°rio</label><input type="text" id="login-user" autocomplete="off"></div><div class="input-group"><label>Senha</label><input type="password" id="login-pass" autocomplete="new-password"></div><div class="modal-actions"><button onclick="window.app.verificarLogin()" class="btn-primary">Entrar</button><button onclick="window.app.fecharLogin()" class="btn-danger">Cancelar</button></div></div></div>
<div id="modal-edit" class="modal-overlay"><div class="modal-card"><h3>‚úèÔ∏è Editar</h3><input type="hidden" id="edit-user-id-hidden"><div class="input-group"><label>Nome</label><input type="text" id="edit-user-name"></div><div class="input-group"><label>Unidade</label><select id="edit-user-unit"><option value="">...</option></select></div><div class="input-group"><label>Regime</label><select id="edit-user-scale"><option value="comum">Comum</option><option value="12x36">12x36</option></select></div><div class="input-group"><label>Carga Hor√°ria</label><input type="number" id="edit-user-hours"></div><div class="modal-actions"><button onclick="window.app.salvarEdicao()" class="btn-success">Salvar</button><button onclick="document.getElementById('modal-edit').classList.remove('active')" class="btn-danger">Cancelar</button></div></div></div>
<div id="modal-admin-justify" class="modal-overlay"><div class="modal-card"><h3>üìù Abonar / Justificar</h3><p id="justify-target-info" style="color:var(--primary);margin-bottom:15px;"></p><input type="hidden" id="justify-log-id"><div class="input-group"><div style="display:flex;gap:10px;margin-bottom:10px;"><button onclick="window.app.aplicarBonificacaoDireta()" class="btn-success" style="flex:1;">‚úÖ Bonificar</button><button onclick="window.app.prepararJustificativa()" class="btn-secondary" style="flex:1;">üìù Justificar (Texto)</button></div></div><div id="justify-text-area" style="display:none;"><textarea id="admin-justification-text" rows="5" oninput="window.app.contarPalavras()" style="width:100%;color:#333;background:white;" placeholder="Digite a justificativa..."></textarea><p id="word-count" style="text-align:right;font-size:0.7rem;color:#888;">0/20</p><div class="modal-actions"><button id="btn-save-justify" onclick="window.app.salvarJustificativaAdmin()" class="btn-success" disabled>Salvar Justificativa</button></div></div><div class="modal-actions"><button onclick="window.app.fecharModalJustify()" class="btn-danger" style="width:100%">Fechar</button></div></div></div>
<div id="modal-justification" class="modal-overlay"><div class="modal-card" style="border:2px solid #f59e0b;background:#fffbeb;"><h3 style="color:#b45309;">‚ö†Ô∏è Ponto Externo</h3><p style="color:#78350f;margin-bottom:10px;">Fora dos locais cadastrados.</p><textarea id="justification-text" rows="3" style="background:white;color:black;width:100%;"></textarea><div class="modal-actions"><button id="btn-send-justification" class="btn-primary">Enviar</button><button onclick="window.app.cancelarPonto()" class="btn-danger">Cancelar</button></div></div></div>
<div id="custom-alert" class="modal-overlay"><div class="modal-card" style="text-align:center;"><span class="alert-title" id="alert-title">Aviso</span><span class="alert-msg" id="alert-msg"></span><button onclick="window.app.fecharAlert()" class="btn-primary">OK</button></div></div>
<div id="custom-confirm" class="modal-overlay"><div class="modal-card" style="text-align:center;"><span class="alert-title">Confirma√ß√£o</span><span class="alert-msg" id="confirm-msg"></span><div class="modal-actions"><button id="confirm-yes" class="btn-danger">Sim</button><button onclick="window.app.fecharConfirm()" class="btn-secondary">N√£o</button></div></div></div>
<canvas id="capture-canvas" style="display:none;"></canvas>

<!-- SCRIPT -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let firebaseConfig;
    let USERS_COLLECTION, LOGS_COLLECTION, PLACES_COLLECTION;
    let APP_ID = 'default';

    if (typeof __firebase_config !== 'undefined') {
        firebaseConfig = JSON.parse(__firebase_config);
        APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default';
        USERS_COLLECTION = `artifacts/${APP_ID}/public/data/users`;
        LOGS_COLLECTION = `artifacts/${APP_ID}/public/data/logs`;
        PLACES_COLLECTION = `artifacts/${APP_ID}/public/data/places`;
        console.log("Modo Preview Ativado");
    } else {
        firebaseConfig = {
            apiKey: "AIzaSyBDBx51fCm4lwnSyDC3uIZ-jc7wKM7oTjQ",
            authDomain: "maranatime.firebaseapp.com",
            projectId: "maranatime",
            storageBucket: "maranatime.firebasestorage.app",
            messagingSenderId: "738069003904",
            appId: "1:738069003904:web:cc1ca9a2e2f5545f9c7065",
            measurementId: "G-KTT686MYJ0"
        };
        USERS_COLLECTION = "users";
        LOGS_COLLECTION = "logs";
        PLACES_COLLECTION = "places";
        console.log("Modo Produ√ß√£o Ativado");
    }
    
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    const COMPANY_INFO = {
        nome: "ASSOCIA√á√ÉO MARANATH√Å DO RIO DE JANEIRO",
        endereco: "Rua: Adolfo Bergamini, 199 - Engenho de Dentro - Rio de Janeiro - RJ",
        contato: "CEP 20730-000 - Tel.: (21) 3795-8324, 3439-0385",
        cnpj_site: "CNPJ: 05.284.121/0001-26 - www.maranathario.com"
    };

    const app = {
        adminConfig: { user: "admin", pass: "123" },
        adminLogado: false,
        funcionariosCache: [],
        locaisCache: [], 
        modelosCarregados: false,
        streamAtiva: null,
        faceMatcher: null,
        ultimoRegistro: 0,
        confirmCallback: null,
        pontoPendente: null,
        processando: false,
        chartInstance: null,
        justifyMode: null,

        els: {
            videoMain: document.getElementById('video-feed'),
            videoAdmin: document.getElementById('admin-video-feed'),
            overlay: document.getElementById('ai-overlay'),
            canvas: document.getElementById('capture-canvas'),
            statusDB: document.getElementById('db-status'),
            employeeNameDisplay: document.getElementById('employee-name-display'),
            employeeIdHidden: document.getElementById('employee-id'),
            successMessage: document.getElementById('success-message'),
            errorMessage: document.getElementById('error-message'),
            modalLogin: document.getElementById('modal-login'),
            modalEdit: document.getElementById('modal-edit'),
            modalAlert: document.getElementById('custom-alert'),
            modalConfirm: document.getElementById('custom-confirm'),
            modalJustification: document.getElementById('modal-justification'),
            modalAdminJustify: document.getElementById('modal-admin-justify'),
            dateFilter: document.getElementById('admin-month-filter'),
            unitFilter: document.getElementById('admin-unit-filter'),
            listaLocais: document.getElementById('lista-locais'),
            digitalTime: document.getElementById('digital-time'),
            digitalDate: document.getElementById('digital-date'),
            newUserUnit: document.getElementById('new-user-unit'),
            editUserUnit: document.getElementById('edit-user-unit'),
            dashEmployee: document.getElementById('dashboard-employee-select'),
            dashMonth: document.getElementById('dashboard-month'),
            kpiBalance: document.getElementById('kpi-balance'),
            kpiDays: document.getElementById('kpi-days'),
            kpiPunctuality: document.getElementById('kpi-punctuality'),
            areaJustificativa: document.getElementById('justify-text-area'),
            txtJustificativa: document.getElementById('admin-justification-text'),
            wordCount: document.getElementById('word-count'),
            btnSaveJustify: document.getElementById('btn-save-justify'),
            statusIA: document.getElementById('ia-status'),
            btnRegistrar: document.getElementById('btn-registrar')
        },

        init: async function() {
            this.els.statusDB.innerText = "Nuvem: ...";
            try {
                await signInAnonymously(auth);
                this.els.statusDB.innerText = "Nuvem: OK";
                this.els.statusDB.classList.add('online');
                this.sincronizarLocais(); 
                this.sincronizarFuncionarios();
            } catch (error) {
                this.mostrarAlerta("Erro conex√£o: " + error.message, "Erro");
                return;
            }
            const hoje = new Date();
            const mesStr = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            this.els.dateFilter.value = mesStr;
            this.els.dashMonth.value = mesStr;

            this.iniciarRelogio();
            await this.carregarModelosIA();
            this.iniciarCamera('main');
            document.getElementById('btn-send-justification').onclick = () => this.enviarJustificativa();
        },

        iniciarRelogio: function() {
            setInterval(() => {
                const now = new Date();
                this.els.digitalTime.innerText = now.toLocaleTimeString('pt-BR');
                this.els.digitalDate.innerText = now.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' }).toUpperCase();
            }, 1000);
        },

        // --- GEST√ÉO DE LOCAIS ---
        buscarCoordenadas: async function() {
            const cep = document.getElementById('loc-cep').value.replace(/\D/g, '');
            const num = document.getElementById('loc-num').value;
            if(cep.length !== 8 || !num) return this.mostrarAlerta("Digite CEP e N√∫mero.");
            try {
                const resCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const dataCep = await resCep.json();
                if(dataCep.erro) throw new Error("CEP n√£o encontrado.");
                document.getElementById('loc-address').value = `${dataCep.logradouro}, ${num} - ${dataCep.bairro}, ${dataCep.localidade}/${dataCep.uf}`;
                
                const query = `${num}, ${dataCep.logradouro}, ${dataCep.localidade}, ${dataCep.uf}, Brazil`;
                const resGeo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
                const dataGeo = await resGeo.json();
                if(dataGeo.length === 0) throw new Error("Endere√ßo n√£o localizado.");
                document.getElementById('loc-lat').value = dataGeo[0].lat;
                document.getElementById('loc-lon').value = dataGeo[0].lon;
                this.mostrarAlerta(`Endere√ßo localizado!`, "Sucesso");
            } catch(e) { this.mostrarAlerta(e.message, "Erro"); }
        },
        salvarLocal: async function() {
            const nome = document.getElementById('loc-name').value;
            const cnpj = document.getElementById('loc-cnpj').value;
            const endereco = document.getElementById('loc-address').value;
            const lat = parseFloat(document.getElementById('loc-lat').value);
            const lng = parseFloat(document.getElementById('loc-lon').value);
            if (!nome || !cnpj || !endereco || isNaN(lat)) return this.mostrarAlerta("Preencha todos os dados.");
            try { await addDoc(collection(db, PLACES_COLLECTION), { nome, cnpj, endereco, lat, lng }); this.mostrarAlerta("Salvo!", "Sucesso"); document.getElementById('loc-name').value = ""; document.getElementById('loc-cnpj').value = ""; document.getElementById('loc-address').value = ""; document.getElementById('loc-cep').value = ""; document.getElementById('loc-num').value = ""; document.getElementById('loc-lat').value = ""; document.getElementById('loc-lon').value = ""; } catch (e) { this.mostrarAlerta(e.message, "Erro"); }
        },
        sincronizarLocais: function() {
            const q = query(collection(db, PLACES_COLLECTION));
            onSnapshot(q, (querySnapshot) => {
                this.locaisCache = [];
                this.els.listaLocais.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    const local = doc.data();
                    this.locaisCache.push({ docId: doc.id, ...local });
                    const div = document.createElement('div');
                    div.className = 'local-item';
                    div.innerHTML = `<div class="local-info"><b>${local.nome}</b><small>${local.cnpj}</small></div>`;
                    this.els.listaLocais.appendChild(div);
                });
                this.atualizarOpcoesUnidades(); 
            });
        },
        atualizarOpcoesUnidades: function() {
            const optionsHTML = '<option value="">Selecione...</option>' + this.locaisCache.map(l => `<option value="${l.nome}">${l.nome}</option>`).join('');
            this.els.newUserUnit.innerHTML = optionsHTML;
            this.els.editUserUnit.innerHTML = optionsHTML;
            const filterOptions = '<option value="">Todas</option>' + this.locaisCache.map(l => `<option value="${l.nome}">${l.nome}</option>`).join('');
            this.els.unitFilter.innerHTML = filterOptions;
        },

        // --- CADASTRO COLABORADOR ---
        cadastrarBiometria: async function() {
            if (!this.modelosCarregados) return this.mostrarAlerta("Aguarde a IA...");
            const id = document.getElementById('new-user-id').value;
            const nome = document.getElementById('new-user-name').value;
            const unidade = document.getElementById('new-user-unit').value;
            const scale = document.getElementById('new-user-scale').value;
            const horas = document.getElementById('new-user-hours').value;
            const entrada = document.getElementById('new-user-start').value;
            const pausa = document.getElementById('new-user-break').value;
            const saida = document.getElementById('new-user-end').value;

            if (!id || !nome || !unidade || !entrada || !saida) return this.mostrarAlerta("Preencha campos e hor√°rios.");
            if (this.funcionariosCache.find(u => u.id == id)) return this.mostrarAlerta("ID existe!");
            
            const detection = await faceapi.detectSingleFace(this.els.videoAdmin, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (!detection) return this.mostrarAlerta("Rosto n√£o detectado!");
            
            const descriptorObj = { ...detection.descriptor }; 
            try { 
                await addDoc(collection(db, USERS_COLLECTION), { 
                    id, nome, unidade, scale, 
                    horarioEntrada: entrada, tempoPausa: pausa, horarioSaida: saida, 
                    horasSemanais: horas, descriptor: descriptorObj 
                }); 
                this.mostrarAlerta("Cadastrado!", "Sucesso"); 
                document.getElementById('new-user-id').value = ''; 
                document.getElementById('new-user-name').value = '';
            } catch (e) { this.mostrarAlerta(e.message, "Erro"); }
        },

        sincronizarFuncionarios: function() {
            const q = query(collection(db, USERS_COLLECTION));
            onSnapshot(q, (querySnapshot) => {
                this.funcionariosCache = [];
                const labeledDescriptors = [];
                const dashboardSelect = this.els.dashEmployee;
                dashboardSelect.innerHTML = '<option value="">Selecione...</option>'; 

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.descriptor) {
                        const values = Object.values(data.descriptor);
                        data.descriptor = new Float32Array(values);
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(data.id.toString(), [data.descriptor]));
                    }
                    this.funcionariosCache.push({ docId: doc.id, ...data });
                    const opt = document.createElement('option');
                    opt.value = data.id;
                    opt.innerText = `${data.nome}`;
                    dashboardSelect.appendChild(opt);
                });
                if (labeledDescriptors.length > 0) {
                    this.faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
                    console.log("IA Atualizada com", labeledDescriptors.length, "faces.");
                }
                this.atualizarFiltrosUnidade();
                if(document.getElementById('view-admin').style.display === 'block') this.renderizarListaFuncionarios();
            });
        },

        // --- DASHBOARD ---
        atualizarDashboard: async function() {
            const userId = this.els.dashEmployee.value;
            const mesAno = this.els.dashMonth.value;
            if (!userId || !mesAno) return;
            const func = this.funcionariosCache.find(u => u.id == userId);
            if (!func) return;

            const q = query(collection(db, LOGS_COLLECTION)); 
            const snapshot = await getDocs(q);
            const registros = [];
            snapshot.forEach(doc => { const d = doc.data(); if(d.mesAno === mesAno && d.id == userId) registros.push(d); });

            const pontosPorDia = {};
            registros.forEach(r => {
                if (!pontosPorDia[r.data]) pontosPorDia[r.data] = [];
                const [h, m] = r.hora.split(':').map(Number);
                pontosPorDia[r.data].push(h * 60 + m);
            });

            let minutosTotais = 0; let diasTrabalhados = Object.keys(pontosPorDia).length; let diasPontuais = 0;
            const diasLabels = []; const horasData = [];
            const diasOrdenados = Object.keys(pontosPorDia).sort((a, b) => { const [d1, m1, y1] = a.split('/'); const [d2, m2, y2] = b.split('/'); return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2); });

            diasOrdenados.forEach(dia => {
                const batidas = pontosPorDia[dia].sort((a, b) => a - b);
                let minutosDia = 0;
                if (batidas.length > 0 && batidas[0] <= 485) diasPontuais++; 
                for (let i = 0; i < batidas.length - 1; i += 2) minutosDia += (batidas[i+1] - batidas[i]);
                minutosTotais += minutosDia;
                diasLabels.push(dia.substring(0, 5));
                horasData.push((minutosDia / 60).toFixed(2));
            });

            const cargaSemanal = parseFloat(func.horasSemanais || 44);
            const cargaMensal = (cargaSemanal / 6) * 30; 
            const horasTrabalhadas = minutosTotais / 60;
            const saldo = horasTrabalhadas - cargaMensal;
            const taxaPontualidade = diasTrabalhados > 0 ? (diasPontuais / diasTrabalhados) * 100 : 0;

            this.els.kpiDays.innerText = diasTrabalhados;
            this.els.kpiPunctuality.innerText = taxaPontualidade.toFixed(0) + "%";
            const saldoElem = this.els.kpiBalance;
            saldoElem.innerText = saldo.toFixed(2) + "h";
            saldoElem.style.color = saldo >= 0 ? "var(--success)" : "var(--danger)";
            this.renderizarGrafico(diasLabels, horasData);
        },

        renderizarGrafico: function(labels, data) {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            if (this.chartInstance) this.chartInstance.destroy();
            this.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Horas', data: data, backgroundColor: 'rgba(14, 165, 233, 0.6)', borderColor: '#0ea5e9', borderWidth: 1, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false } } } });
        },

        // --- JUSTIFICATIVA ADMIN ---
        abrirJustificativaAdmin: function(docId, nome) {
            document.getElementById('justify-log-id').value = docId;
            document.getElementById('justify-target-info').innerText = `Colaborador: ${nome}`;
            this.els.modalAdminJustify.classList.add('active');
            this.els.areaJustificativa.style.display = 'none'; // Reseta visual
            this.els.btnSaveJustify.disabled = true;
        },

        aplicarBonificacaoDireta: async function() {
            if(!confirm("Deseja abonar este ponto automaticamente?")) return;
            const docId = document.getElementById('justify-log-id').value;
            try {
                await updateDoc(doc(db, LOGS_COLLECTION, docId), {
                    adminStatus: 'bonificado',
                    adminNote: 'Abonado Automaticamente'
                });
                this.mostrarAlerta("Ponto abonado com sucesso!", "Sucesso");
                this.fecharModalJustify();
                this.carregarTabelaPontos();
            } catch (e) { this.mostrarAlerta("Erro: " + e.message, "Erro"); }
        },

        prepararJustificativa: function() {
            this.els.areaJustificativa.style.display = 'block';
            this.els.txtJustificativa.value = "";
            this.els.btnSaveJustify.disabled = true;
        },

        contarPalavras: function() {
            const texto = this.els.txtJustificativa.value.trim();
            const palavras = texto.length > 0 ? texto.split(/\s+/).length : 0;
            this.els.wordCount.innerText = `${palavras}/20 palavras`;
            this.els.btnSaveJustify.disabled = (palavras < 20);
        },

        salvarJustificativaAdmin: async function() {
            const docId = document.getElementById('justify-log-id').value;
            const texto = this.els.txtJustificativa.value;
            try { 
                await updateDoc(doc(db, LOGS_COLLECTION, docId), { adminStatus: 'justificado', adminNote: texto }); 
                this.mostrarAlerta("Justificativa Salva!", "Sucesso"); 
                this.fecharModalJustify(); 
                this.carregarTabelaPontos(); 
            } catch (e) { this.mostrarAlerta("Erro: " + e.message, "Erro"); }
        },

        fecharModalJustify: function() { this.els.modalAdminJustify.classList.remove('active'); },

        // --- RELAT√ìRIOS ---
        imprimirRelatorioFechamento: async function() {
            const mes = this.els.dateFilter.value;
            const unidNome = document.getElementById('admin-unit-filter').value;
            if(!mes) return this.mostrarAlerta("Selecione um m√™s.");

            let unitInfo = COMPANY_INFO; 
            if (unidNome && unidNome !== "") {
                const local = this.locaisCache.find(l => l.nome === unidNome);
                if (local) {
                    unitInfo = {
                        nome: "GRUPO MARANATH√Å - " + local.nome.toUpperCase(),
                        endereco: local.endereco || "Endere√ßo n√£o cadastrado",
                        contato: "",
                        cnpj_site: "CNPJ: " + (local.cnpj || "N/A")
                    };
                }
            }

            const q = query(collection(db, LOGS_COLLECTION));
            const snapshot = await getDocs(q);
            const registros = []; 
            snapshot.forEach(doc => { const d = doc.data(); if(d.mesAno === mes) registros.push(d); });
            
            const registrosFiltrados = unidNome ? registros.filter(r => r.unidade === unidNome) : registros;
            if(registrosFiltrados.length === 0) return this.mostrarAlerta("Sem dados para esta unidade.");

            const resumo = {};
            this.funcionariosCache.forEach(f => {
                if (!unidNome || f.unidade === unidNome) {
                    resumo[f.id] = { nome: f.nome, unidade: f.unidade, scale: f.scale || "comum", dias: new Set(), pontos: {} };
                }
            });

            registrosFiltrados.forEach(r => {
                if(resumo[r.id]) {
                    resumo[r.id].dias.add(r.data);
                    if(!resumo[r.id].pontos[r.data]) resumo[r.id].pontos[r.data] = [];
                    const [h, m] = r.hora.split(':').map(Number);
                    resumo[r.id].pontos[r.data].push(h * 60 + m);
                }
            });

            let linhasHTML = "";
            Object.keys(resumo).forEach(id => {
                const f = resumo[id];
                let minTotais = 0;
                Object.values(f.pontos).forEach(batidas => {
                    batidas.sort((a,b) => a - b);
                    for(let i = 0; i < batidas.length - 1; i += 2) minTotais += (batidas[i+1] - batidas[i]);
                });
                const horasTrab = (minTotais / 60).toFixed(2);
                linhasHTML += `<tr><td>${id}</td><td>${f.nome}</td><td>${f.unidade}</td><td>${f.scale}</td><td>${f.dias.size}</td><td>${horasTrab}h</td></tr>`;
            });
            this.gerarRelatorioImpresso(`Fechamento - ${mes} - ${unidNome || 'Geral'}`, ["ID", "Nome", "Unidade", "Escala", "Dias Trab.", "Horas Trab."], linhasHTML, unitInfo);
        },
        gerarRelatorioImpresso: function(titulo, colunas, linhasHTML, companyData = COMPANY_INFO) { const janela = window.open('', '_blank'); const dataHoje = new Date().toLocaleDateString('pt-BR'); const conteudo = `<html><head><title>${titulo}</title><style>body{font-family:'Times New Roman';padding:40px;}.header{text-align:center;border-bottom:2px solid #1e3a8a;padding-bottom:20px;}.header h1{font-size:18pt;color:#1e3a8a;margin:0;}.header p{font-size:10pt;margin:2px;}table{width:100%;border-collapse:collapse;margin-top:20px;font-size:10pt;font-family:Arial;}th,td{border:1px solid #000;padding:6px;text-align:center;}th{background-color:#e0e0e0;}@page{size:landscape;margin:1.5cm;}</style></head><body><div class="header"><h1>${companyData.nome}</h1><p>${companyData.endereco}</p><p>${companyData.cnpj_site}</p></div><h2 style="text-align:center">${titulo}</h2><p style="text-align:right">Emiss√£o: ${dataHoje}</p><table><thead><tr>${colunas.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${linhasHTML}</tbody></table><script>window.onload=function(){window.print()}<\/script></body></html>`; janela.document.write(conteudo); janela.document.close(); },

        carregarTabelaPontos: async function() {
            const mes = this.els.dateFilter.value;
            if(!mes) return this.mostrarAlerta("Escolha o m√™s.");
            const tbody = document.getElementById('logs-tbody');
            tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            
            const q = query(collection(db, LOGS_COLLECTION));
            const snapshot = await getDocs(q);
            let dados = []; snapshot.forEach(doc => { const d = doc.data(); if(d.mesAno === mes) dados.push({ docId: doc.id, ...d }); });
            
            const unid = document.getElementById('admin-unit-filter').value;
            if(unid) dados = dados.filter(d => d.unidade === unid);
            dados.sort((a,b) => b.timestamp - a.timestamp);
            
            tbody.innerHTML = '';
            if (dados.length === 0) { tbody.innerHTML = '<tr><td colspan="6">Vazio.</td></tr>'; return; }
            
            dados.forEach(r => {
                const func = this.funcionariosCache.find(u => u.id == r.id);
                let classeIrregular = "";
                let statusTexto = "OK";
                
                if (func && r.tipo === "Entrada" && func.horarioEntrada) {
                    const [hP, mP] = func.horarioEntrada.split(':').map(Number);
                    const [hR, mR] = r.hora.split(':').map(Number);
                    const minutosPrevistos = hP * 60 + mP;
                    const minutosReais = hR * 60 + mR;
                    if (minutosReais > minutosPrevistos + 10) {
                        classeIrregular = "irregular";
                        statusTexto = "ATRASO";
                    }
                }
                if (r.adminStatus === "bonificado") { classeIrregular = "abonado"; statusTexto = "ABONADO"; }
                if (r.adminStatus === "justificado") { classeIrregular = "abonado"; statusTexto = "JUSTIFICADO"; }

                tbody.innerHTML += `<tr class="${classeIrregular}"><td>${r.data}</td><td>${r.hora}</td><td>${r.nome}</td><td>${r.tipo}</td><td>${statusTexto}</td><td><button class="btn-edit" onclick="window.app.abrirJustificativaAdmin('${r.docId}', '${r.nome}')">Abonar/Justificar</button></td></tr>`;
            });
        },
        
        // ... (RESTANTE DAS FUN√á√ïES MANTIDAS: inicarCamera, modelosIA, etc.)
        iniciarRelogio: function() { setInterval(() => { const now = new Date(); this.els.digitalTime.innerText = now.toLocaleTimeString('pt-BR'); this.els.digitalDate.innerText = now.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' }).toUpperCase(); }, 1000); },
        buscarCoordenadas: async function() { const cep = document.getElementById('loc-cep').value.replace(/\D/g, ''); const num = document.getElementById('loc-num').value; if(cep.length !== 8 || !num) return this.mostrarAlerta("Digite CEP e N√∫mero."); try { const resCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const dataCep = await resCep.json(); if(dataCep.erro) throw new Error("CEP n√£o encontrado."); document.getElementById('loc-address').value = `${dataCep.logradouro}, ${num} - ${dataCep.bairro}, ${dataCep.localidade}/${dataCep.uf}`; const query = `${num}, ${dataCep.logradouro}, ${dataCep.localidade}, ${dataCep.uf}, Brazil`; const resGeo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`); const dataGeo = await resGeo.json(); if(dataGeo.length === 0) throw new Error("Endere√ßo n√£o localizado."); document.getElementById('loc-lat').value = dataGeo[0].lat; document.getElementById('loc-lon').value = dataGeo[0].lon; this.mostrarAlerta(`Endere√ßo localizado!`, "Sucesso"); } catch(e) { this.mostrarAlerta(e.message, "Erro"); } },
        salvarLocal: async function() { const nome = document.getElementById('loc-name').value; const cnpj = document.getElementById('loc-cnpj').value; const endereco = document.getElementById('loc-address').value; const lat = parseFloat(document.getElementById('loc-lat').value); const lng = parseFloat(document.getElementById('loc-lon').value); if (!nome || !cnpj || !endereco || isNaN(lat)) return this.mostrarAlerta("Preencha todos os dados."); try { await addDoc(collection(db, PLACES_COLLECTION), { nome, cnpj, endereco, lat, lng }); this.mostrarAlerta("Salvo!", "Sucesso"); } catch (e) { this.mostrarAlerta(e.message, "Erro"); } },
        renderizarListaFuncionarios: function() { const tbody = document.getElementById('employees-tbody'); const filterUnit = this.els.employeesUnitFilter.value; let lista = this.funcionariosCache; if (filterUnit) lista = lista.filter(u => u.unidade === filterUnit); tbody.innerHTML = ''; lista.forEach(u => { tbody.innerHTML += `<tr><td>${u.id}</td><td>${u.nome}</td><td>${u.unidade}</td><td>${u.scale || 'comum'}</td><td><button class="btn-edit" onclick="window.app.abrirEdicao('${u.id}')">‚úèÔ∏è</button><button class="btn-danger small" onclick="window.app.excluirUsuario('${u.docId}')">üóëÔ∏è</button></td></tr>`; }); },
        excluirUsuario: async function(docId) { if(confirm("Excluir?")) { try { await deleteDoc(doc(db, USERS_COLLECTION, docId)); } catch(e) { alert(e.message); } } },
        abrirEdicao: function(id) { const user = this.funcionariosCache.find(u => u.id == id); if (!user) return; document.getElementById('edit-user-id-hidden').value = user.docId; document.getElementById('edit-user-name').value = user.nome; document.getElementById('edit-user-unit').value = user.unidade; document.getElementById('edit-user-scale').value = user.scale || 'comum'; document.getElementById('edit-user-hours').value = user.horasSemanais; this.els.modalEdit.classList.add('active'); },
        salvarEdicao: async function() { const docId = document.getElementById('edit-user-id-hidden').value; try { await updateDoc(doc(db, USERS_COLLECTION, docId), { nome: document.getElementById('edit-user-name').value, unidade: document.getElementById('edit-user-unit').value, scale: document.getElementById('edit-user-scale').value, horasSemanais: document.getElementById('edit-user-hours').value }); this.mostrarAlerta("Atualizado!", "Sucesso"); this.els.modalEdit.classList.remove('active'); } catch (e) { this.mostrarAlerta(e.message, "Erro"); } },
        getDistanceFromLatLonInKm: function(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = this.deg2rad(lat2 - lat1); const dLon = this.deg2rad(lon2 - lon1); const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c * 1000; },
        deg2rad: function(deg) { return deg * (Math.PI/180) },
        verificarLocalizacao: function(lat, lng) { const TOLERANCIA = 150; for (let local of this.locaisCache) { const dist = this.getDistanceFromLatLonInKm(lat, lng, local.lat, local.lng); if (dist <= TOLERANCIA) return { autorizado: true, nome: local.nome }; } return { autorizado: false, nome: "EXTERNO" }; },
        processarReconhecimento: function(id) { if (this.processando) return; const agora = Date.now(); if (agora - this.ultimoRegistro < 10000) return; const func = this.funcionariosCache.find(u => u.id == id); if (func) { this.processando = true; this.els.employeeNameDisplay.value = func.nome.split(' ')[0]; this.els.employeeIdHidden.value = id; this.ultimoRegistro = agora; this.iniciarRegistroPonto(func, true); } },
        iniciarRegistroPonto: function(func, automatico = false) { if (!navigator.geolocation) { this.prepararRegistro(func, automatico, null, null, "Sem GPS", false); return; } navigator.geolocation.getCurrentPosition((pos) => { const lat = pos.coords.latitude; const lng = pos.coords.longitude; const statusLocal = this.verificarLocalizacao(lat, lng); this.prepararRegistro(func, automatico, lat, lng, statusLocal.nome, statusLocal.autorizado); }, (err) => { this.prepararRegistro(func, automatico, null, null, "GPS Bloqueado", false); }, { enableHighAccuracy: true, timeout: 10000 }); },
        prepararRegistro: function(func, automatico, lat, lng, localNome, autorizado) { const tipo = document.getElementById('punch-type').value; const agora = new Date(); this.pontoPendente = { func, tipo, agora, lat, lng, localNome, automatico }; if (autorizado) { this.finalizarRegistro(null); } else { this.ultimoRegistro = Date.now() + 60000; document.getElementById('justification-text').value = ""; this.els.modalJustification.classList.add('active'); } },
        enviarJustificativa: function() { const just = document.getElementById('justification-text').value; if (!just || just.trim().length < 5) return alert("Por favor, justifique."); this.els.modalJustification.classList.remove('active'); this.finalizarRegistro(just); },
        cancelarPonto: function() { this.els.modalJustification.classList.remove('active'); this.pontoPendente = null; this.ultimoRegistro = 0; this.processando = false; this.els.employeeNameDisplay.value = ""; },
        finalizarRegistro: async function(justificativa = null) { const { func, tipo, agora, lat, lng, localNome, automatico } = this.pontoPendente; const dataHoje = agora.toLocaleDateString('pt-BR'); const mesAno = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`; try { const q = query(collection(db, LOGS_COLLECTION), where("id", "==", func.id), where("data", "==", dataHoje), where("tipo", "==", tipo)); const querySnapshot = await getDocs(q); if (!querySnapshot.empty) { if (!automatico) this.mostrarAlerta("Per√≠odo duplicado.", "‚ö†Ô∏è Aten√ß√£o", "error"); else this.mostrarErro(`‚ö†Ô∏è ${tipo} duplicado!`); this.els.employeeNameDisplay.value = ""; this.processando = false; return; } } catch (err) { console.error(err); } const ctx = this.els.canvas.getContext('2d'); this.els.canvas.width = this.els.videoMain.videoWidth; this.els.canvas.height = this.els.videoMain.videoHeight; ctx.drawImage(this.els.videoMain, 0, 0); const foto = this.els.canvas.toDataURL('image/jpeg', 0.3); try { await addDoc(collection(db, LOGS_COLLECTION), { timestamp: agora.getTime(), id: func.id, nome: func.nome, unidade: func.unidade, tipo: tipo, data: dataHoje, hora: agora.toLocaleTimeString('pt-BR'), mesAno: mesAno, foto: foto, modo: automatico ? "Auto IA" : "Manual", latitude: lat, longitude: lng, localizacaoNome: localNome, justificativa: justificativa }); this.mostrarSucesso(`Ponto Registrado!\n${localNome}`); setTimeout(() => { this.els.employeeNameDisplay.value = ""; this.processando = false; }, 3000); } catch (e) { console.error(e); this.processando = false; } },
        mostrarSucesso: function(texto) { this.els.successText.innerText = texto; this.els.successMessage.style.display = "block"; setTimeout(() => { this.els.successMessage.style.display = "none"; }, 3000); },
        mostrarErro: function(texto) { this.els.errorText.innerText = texto; this.els.errorMessage.style.display = "block"; setTimeout(() => { this.els.errorMessage.style.display = "none"; }, 3000); },
        mostrarAlerta: function(msg, titulo = "Aviso", tipo = "normal") { const card = this.els.modalAlert.querySelector('.modal-card'); card.classList.remove('error-style'); if (tipo === "error") card.classList.add('error-style'); document.getElementById('alert-title').innerText = titulo; document.getElementById('alert-msg').innerText = msg; this.els.modalAlert.classList.add('active'); },
        fecharAlert: function() { this.els.modalAlert.classList.remove('active'); },
        mostrarConfirmacao: function(msg, callback) { document.getElementById('confirm-msg').innerText = msg; this.confirmCallback = callback; this.els.modalConfirm.classList.add('active'); const btnYes = document.getElementById('confirm-yes'); const newBtn = btnYes.cloneNode(true); btnYes.parentNode.replaceChild(newBtn, btnYes); newBtn.addEventListener('click', () => { if (this.confirmCallback) this.confirmCallback(); this.fecharConfirm(); }); },
        fecharConfirm: function() { this.els.modalConfirm.classList.remove('active'); this.confirmCallback = null; },
        carregarModelosIA: async function() { this.els.statusIA.innerText = "IA: Baixando..."; try { await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'), faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'), faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'), faceapi.nets.ssdMobilenetv1.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')]); this.modelosCarregados = true; this.els.statusIA.innerText = "IA: Online üü¢"; this.els.statusIA.classList.add('ready'); this.iniciarDeteccaoContinua(); } catch (e) { console.error(e); this.els.statusIA.innerText = "IA: Erro üî¥"; } },
        iniciarCamera: async function(tipo) { if (this.streamAtiva) this.streamAtiva.getTracks().forEach(track => track.stop()); try { const stream = await navigator.mediaDevices.getUserMedia({ video: {} }); this.streamAtiva = stream; if (tipo === 'main') { this.els.videoMain.srcObject = stream; this.els.videoAdmin.srcObject = null; } else { this.els.videoAdmin.srcObject = stream; this.els.videoMain.srcObject = null; } } catch (e) { console.error("Erro Cam", e); } },
        iniciarDeteccaoContinua: function() { const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }); const loop = async () => { if (this.modelosCarregados && !this.els.videoMain.paused && this.els.videoMain.srcObject !== null && this.faceMatcher && document.getElementById('view-ponto').style.display !== 'none') { try { const detections = await faceapi.detectAllFaces(this.els.videoMain, options).withFaceLandmarks().withFaceDescriptors(); const dims = faceapi.matchDimensions(this.els.overlay, this.els.videoMain, true); const resized = faceapi.resizeResults(detections, dims); const ctx = this.els.overlay.getContext('2d'); ctx.clearRect(0, 0, this.els.overlay.width, this.els.overlay.height); resized.forEach(detection => { const match = this.faceMatcher.findBestMatch(detection.descriptor); const box = detection.detection.box; if (match.label !== 'unknown') { new faceapi.draw.DrawBox(box, { label: match.label, boxColor: '#00ff00' }).draw(this.els.overlay); this.processarReconhecimento(match.label); } else { new faceapi.draw.DrawBox(box, { label: "Desconhecido", boxColor: '#ff0000' }).draw(this.els.overlay); } }); } catch (err) { } } requestAnimationFrame(loop); }; loop(); },
        cadastrarBiometria: async function() { if (!this.modelosCarregados) return this.mostrarAlerta("Aguarde a IA..."); const id = document.getElementById('new-user-id').value; const nome = document.getElementById('new-user-name').value; const unidade = document.getElementById('new-user-unit').value; const horas = document.getElementById('new-user-hours').value; if (!id || !nome || !unidade) return this.mostrarAlerta("Preencha campos."); if (this.funcionariosCache.find(u => u.id == id)) return this.mostrarAlerta("ID existe!"); const detection = await faceapi.detectSingleFace(this.els.videoAdmin, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor(); if (!detection) return this.mostrarAlerta("Rosto n√£o detectado!"); const descriptorObj = { ...detection.descriptor }; try { await addDoc(collection(db, USERS_COLLECTION), { id: id, nome: nome, unidade: unidade, horasSemanais: horas, descriptor: descriptorObj }); this.mostrarAlerta("Cadastrado!", "Sucesso"); document.getElementById('new-user-id').value = ''; document.getElementById('new-user-name').value = ''; } catch (e) { this.mostrarAlerta(e.message, "Erro"); } },
        atualizarFiltrosUnidade: function() { const unidades = [...new Set(this.funcionariosCache.map(f => f.unidade))]; const opts = '<option value="">Todas</option>' + unidades.map(u => `<option value="${u}">${u}</option>`).join(''); this.els.unitFilter.innerHTML = opts; this.els.employeesUnitFilter.innerHTML = opts; },
        switchTab: function(tab) { if(tab === 'admin' && !this.adminLogado) { this.els.modalLogin.classList.add('active'); return; } if(tab !== 'admin') this.adminLogado = false; document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById(`view-${tab}`).classList.add('active'); if (tab === 'admin') { this.iniciarCamera('admin'); this.renderizarListaFuncionarios(); this.carregarHistoricoRecente(); } else { this.iniciarCamera('main'); } },
        verificarLogin: function() { if (document.getElementById('login-user').value === this.adminConfig.user && document.getElementById('login-pass').value === this.adminConfig.pass) { this.adminLogado = true; this.els.modalLogin.classList.remove('active'); document.getElementById('login-user').value = ''; document.getElementById('login-pass').value = ''; this.switchTab('admin'); } else { this.mostrarAlerta("Senha incorreta", "Erro"); } },
        fecharLogin: function() { this.els.modalLogin.classList.remove('active'); },
        logoutAdmin: function() { this.adminLogado = false; this.switchTab('ponto'); },
        buscarCoordenadas: async function() { const cep = document.getElementById('loc-cep').value.replace(/\D/g, ''); const num = document.getElementById('loc-num').value; if(cep.length !== 8 || !num) return this.mostrarAlerta("Digite CEP e N√∫mero.", "Aviso"); try { const resCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const dataCep = await resCep.json(); if(dataCep.erro) throw new Error("CEP n√£o encontrado."); document.getElementById('loc-address').value = `${dataCep.logradouro}, ${num} - ${dataCep.bairro}, ${dataCep.localidade}/${dataCep.uf}`; const query = `${num}, ${dataCep.logradouro}, ${dataCep.localidade}, ${dataCep.uf}, Brazil`; const resGeo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`); const dataGeo = await resGeo.json(); if(dataGeo.length === 0) throw new Error("Endere√ßo n√£o localizado."); document.getElementById('loc-lat').value = dataGeo[0].lat; document.getElementById('loc-lon').value = dataGeo[0].lon; this.mostrarAlerta(`Endere√ßo localizado!`, "Sucesso"); } catch(e) { this.mostrarAlerta(e.message, "Erro"); } },
        salvarLocal: async function() { const nome = document.getElementById('loc-name').value; const cnpj = document.getElementById('loc-cnpj').value; const endereco = document.getElementById('loc-address').value; const lat = parseFloat(document.getElementById('loc-lat').value); const lng = parseFloat(document.getElementById('loc-lon').value); if (!nome || !cnpj || !endereco || isNaN(lat)) return this.mostrarAlerta("Preencha todos os dados."); try { await addDoc(collection(db, PLACES_COLLECTION), { nome, cnpj, endereco, lat, lng }); this.mostrarAlerta("Unidade Salva!", "Sucesso"); } catch (e) { this.mostrarAlerta(e.message, "Erro"); } },
    };

    window.app = app;
    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>