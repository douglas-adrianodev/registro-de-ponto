<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaranaTime - Gest√£o Inteligente</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <style>
        /* --- TEMA --- */
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --input-bg: #334155;
            --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155;
            --primary: #0ea5e9; --secondary: #6366f1;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        html, body { height: 100%; width: 100%; background: var(--bg); color: var(--text); overflow: hidden; font-size: 14px; }
        
        .app-container { height: 100%; display: flex; flex-direction: column; position: relative; }

        /* --- UI COMPONENTS --- */
        .screen { display: none; flex-direction: column; height: 100%; padding: 15px; overflow-y: auto; align-items: center; }
        .screen.active { display: flex; animation: fadeIn 0.3s; }

        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 500px; margin-top: 20px; }
        .action-btn {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px;
            padding: 30px 10px; display: flex; flex-direction: column; align-items: center; gap: 10px;
            cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .action-btn:active { transform: scale(0.98); }
        .action-btn span { font-size: 2.5rem; }
        .btn-entry { border-bottom: 4px solid var(--success); }
        .btn-pause { border-bottom: 4px solid var(--warning); }
        .btn-return { border-bottom: 4px solid var(--primary); }
        .btn-exit { border-bottom: 4px solid var(--danger); }

        .camera-wrapper { width: 100%; max-width: 400px; aspect-ratio: 3/4; background: #000; border-radius: 20px; overflow: hidden; position: relative; border: 2px solid var(--primary); margin-bottom: 15px; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #ai-overlay { position: absolute; top:0; left:0; width:100%; height:100%; transform: scaleX(-1); }
        
        .header { width: 100%; padding: 15px; border-bottom: 1px solid var(--border); background: var(--card-bg); display: flex; justify-content: space-between; align-items: center; }
        
        /* BOT√ïES & INPUTS */
        button.primary { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; background: var(--primary); color: white; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.3s; }
        button:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; width: auto; display: inline-block; margin: 2px; }
        
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; display: none; }
        button.loading .spinner { display: inline-block; }
        button.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        input, select, textarea { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 10px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* ADMIN */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; justify-content: center; align-items: center; padding: 15px; }
        .modal-overlay.active { display: flex; }
        .admin-panel { width: 100%; max-width: 900px; height: 90vh; background: var(--bg); border-radius: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .admin-header { padding: 15px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
        .admin-content { padding: 15px; overflow-y: auto; flex: 1; }
        
        .tab-btn { flex: 1; padding: 10px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* TABELA DE REGISTROS */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--card-bg); }
        
        /* CORES DAS LINHAS */
        tr.late td { color: #fca5a5; background: rgba(239, 68, 68, 0.15); } /* Vermelho Atraso */
        tr.ok td { color: #86efac; background: rgba(16, 185, 129, 0.15); } /* Verde Abonado/Justificado */

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-container">
    
    <header class="header">
        <div style="font-weight: bold; color: var(--primary);">‚òÅÔ∏è MaranaTime</div>
        <div id="clock" style="font-family: monospace; color: var(--success);">00:00</div>
        <button onclick="app.abrirLoginAdmin()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">‚öôÔ∏è</button>
    </header>

    <div id="screen-home" class="screen active">
        <h2 style="margin-top: 20px;">O que deseja registrar?</h2>
        <div class="home-grid">
            <div class="action-btn btn-entry" onclick="app.iniciarFluxo('Entrada')"><span>üü¢</span><label>Entrada</label></div>
            <div class="action-btn btn-pause" onclick="app.iniciarFluxo('In√≠cio Pausa')"><span>‚è∏Ô∏è</span><label>In√≠cio Pausa</label></div>
            <div class="action-btn btn-return" onclick="app.iniciarFluxo('Fim Pausa')"><span>‚ñ∂Ô∏è</span><label>Fim Pausa</label></div>
            <div class="action-btn btn-exit" onclick="app.iniciarFluxo('Sa√≠da')"><span>üî¥</span><label>Sa√≠da</label></div>
        </div>
        <p id="system-status" style="margin-top: 30px; color: var(--text-muted); font-size: 0.8rem;">Sistema Pronto</p>
    </div>

    <div id="screen-camera" class="screen">
        <h3 id="camera-title">Identificando...</h3>
        <div class="camera-wrapper">
            <video id="video-feed" autoplay playsinline muted></video>
            <canvas id="ai-overlay"></canvas>
        </div>
        <p id="feedback-msg" style="color: var(--warning);">Posicione o rosto</p>
        <button class="primary" style="background: var(--danger); max-width: 200px;" onclick="app.cancelarFluxo()">Cancelar</button>
    </div>

    <div id="screen-success" class="screen">
        <div style="text-align:center; background:var(--card-bg); padding:30px; border-radius:20px; border:1px solid var(--success);">
            <span style="font-size:4rem;">‚úÖ</span>
            <h2>Registrado!</h2>
            <div style="text-align:left; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin:20px 0;">
                <p><b>Nome:</b> <span id="receipt-name"></span></p>
                <p><b>Tipo:</b> <span id="receipt-type"></span></p>
                <p><b>Hora:</b> <span id="receipt-time"></span></p>
                <p><b>Hash:</b> <span id="receipt-hash" style="font-family:monospace;"></span></p>
            </div>
            <button class="primary" onclick="app.baixarComprovante()">üì• Baixar Comprovante</button>
            <button class="primary" style="background:transparent; border:1px solid var(--border);" onclick="app.voltarHome()">Voltar</button>
        </div>
    </div>

</div>

<div id="modal-login" class="modal-overlay">
    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; width: 300px;">
        <h3>Acesso Gestor</h3>
        <input type="password" id="admin-pass" placeholder="Senha (123)">
        <button class="primary" onclick="app.loginAdmin()">Entrar</button>
        <button class="primary" style="background:transparent; margin-top:5px;" onclick="document.getElementById('modal-login').classList.remove('active')">Cancelar</button>
    </div>
</div>

<div id="modal-justify" class="modal-overlay">
    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; width: 400px; border: 1px solid var(--border);">
        <h3 style="color: var(--warning);">üìù Justificar Ponto</h3>
        <p id="justify-info" style="font-size: 0.9rem; color: var(--text-muted); margin-bottom:10px;"></p>
        <input type="hidden" id="justify-doc-id">
        <textarea id="justify-text" rows="4" placeholder="Descreva o motivo (Ex: Atestado M√©dico entregue)..."></textarea>
        <button class="primary" onclick="app.salvarJustificativa()">üíæ Salvar Justificativa</button>
        <button class="primary" style="background:transparent;" onclick="document.getElementById('modal-justify').classList.remove('active')">Cancelar</button>
    </div>
</div>

<div id="modal-admin" class="modal-overlay">
    <div class="admin-panel">
        <div class="admin-header">
            <h3>Gest√£o</h3>
            <button onclick="app.sairAdmin()" style="background:none; border:none; color:white; font-size:1.2rem;">‚úñ</button>
        </div>
        
        <div style="display:flex; border-bottom:1px solid var(--border);">
            <button class="tab-btn active" onclick="app.mudarAba('cadastro')" id="btn-tab-cadastro">üë§ Colaboradores</button>
            <button class="tab-btn" onclick="app.mudarAba('unidades')" id="btn-tab-unidades">üìç Unidades</button>
            <button class="tab-btn" onclick="app.mudarAba('registros')" id="btn-tab-registros">üìã Hist√≥rico</button>
            <button class="tab-btn" onclick="app.mudarAba('relatorios')" id="btn-tab-relatorios">üñ®Ô∏è Relat√≥rios</button>
        </div>

        <div class="admin-content">
            
            <div id="tab-cadastro">
                <div class="form-row">
                    <input type="text" id="new-id" placeholder="ID Autom√°tico" readonly style="background: rgba(0,0,0,0.3); color: var(--success); font-weight: bold;">
                    <input type="text" id="new-name" placeholder="Nome Completo">
                </div>
                <div class="form-row">
                    <select id="new-scale"><option value="comum">Comum</option><option value="12x36">12x36</option></select>
                    <select id="new-unit-select"><option value="">Selecione Unidade...</option></select>
                </div>
                <div class="form-row">
                    <input type="time" id="new-start" placeholder="Entrada">
                    <input type="time" id="new-end" placeholder="Sa√≠da">
                </div>
                <div class="camera-wrapper" style="height: 180px; margin: 0 auto;">
                    <video id="video-admin" autoplay playsinline muted></video>
                </div>
                <button id="btn-save-user" class="primary" onclick="app.salvarColaborador()">
                    <div class="spinner"></div> <span>üì∏ Salvar Cadastro</span>
                </button>
                <div id="list-users" style="margin-top:20px; font-size:0.85rem; color:#ccc;"></div>
            </div>

            <div id="tab-unidades" style="display:none;">
                <h4>Cadastrar Unidade</h4>
                <input type="text" id="unit-name" placeholder="Nome da Unidade">
                <input type="text" id="unit-address" placeholder="Endere√ßo">
                <div class="form-row">
                    <input type="text" id="unit-lat" placeholder="Latitude">
                    <input type="text" id="unit-lon" placeholder="Longitude">
                </div>
                <button class="primary" style="background: var(--secondary); margin-bottom:10px;" onclick="app.obterGPSAtual()">üìç Pegar GPS Atual</button>
                <button id="btn-save-unit" class="primary" onclick="app.salvarUnidade()">
                    <div class="spinner"></div> <span>Salvar Unidade</span>
                </button>
                <div id="list-units" style="margin-top:20px;"></div>
            </div>

            <div id="tab-registros" style="display:none;">
                <h4>Acompanhamento Di√°rio</h4>
                <table id="table-logs">
                    <thead><tr><th>Nome</th><th>Tipo</th><th>Hora</th><th>Status/Obs</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="tbody-logs"></tbody>
                </table>
                <p style="font-size:0.7rem; color:#fca5a5; margin-top:5px;">* Vermelho: Atraso (>10min)</p>
            </div>

            <div id="tab-relatorios" style="display:none;">
                <h4>Emiss√£o de Relat√≥rios</h4>
                <div class="form-row">
                    <input type="month" id="report-month">
                    <select id="report-unit"><option value="">Todas as Unidades</option></select>
                </div>
                <div class="form-row">
                    <button class="primary" style="background: var(--secondary)" onclick="app.imprimirRelatorioDetalhado()">Extrato Detalhado</button>
                    <button class="primary" onclick="app.imprimirRelatorioFechamento()">Fechamento da Unidade</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // SETUP FIREBASE
    let firebaseConfig;
    let APP_ID = 'marana-v6-final'; 
    if (typeof __firebase_config !== 'undefined') {
        firebaseConfig = JSON.parse(__firebase_config);
        APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default';
    } else {
        firebaseConfig = { apiKey: "AIzaSyBDBx51fCm4lwnSyDC3uIZ-jc7wKM7oTjQ", projectId: "maranatime", appId: "1:738069003904:web:cc1ca9a2e2f5545f9c7065" };
    }
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);
    
    // COLE√á√ïES
    const USERS_COLL = `artifacts/${APP_ID}/users`;
    const PLACES_COLL = `artifacts/${APP_ID}/places`;
    const LOGS_COLL = `artifacts/${APP_ID}/logs`;

    const COMPANY_BASE_INFO = {
        nome: "ASSOCIA√á√ÉO MARANATH√Å DO RIO DE JANEIRO",
        contato: "www.maranathario.com"
    };

    const app = {
        state: {
            users: [],
            units: [],
            modelsLoaded: false,
            stream: null,
            adminStream: null,
            faceMatcher: null,
            currentType: null,
            lastReceipt: null
        },

        els: {
            video: document.getElementById('video-feed'),
            videoAdm: document.getElementById('video-admin'),
            overlay: document.getElementById('ai-overlay'),
            status: document.getElementById('system-status'),
            btnSaveUser: document.getElementById('btn-save-user'),
            btnSaveUnit: document.getElementById('btn-save-unit')
        },

        init: async function() {
            this.updateClock();
            this.els.status.innerText = "Conectando...";
            const hoje = new Date();
            document.getElementById('report-month').value = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
            
            try {
                await signInAnonymously(auth);
                await this.loadAI();
                this.listenData();
                this.els.status.innerText = "Sistema Online üü¢";
            } catch(e) { 
                console.error(e);
                this.els.status.innerText = "Erro de Conex√£o üî¥"; 
            }
        },

        updateClock: () => setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('pt-BR').substring(0,5), 1000),

        loadAI: async function() {
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(URL),
                faceapi.nets.ssdMobilenetv1.loadFromUri(URL)
            ]);
            this.state.modelsLoaded = true;
        },

        listenData: function() {
            onSnapshot(collection(db, USERS_COLL), (snap) => {
                this.state.users = [];
                const descriptors = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    this.state.users.push({ docId: doc.id, ...d });
                    if(d.descriptor) descriptors.push(new faceapi.LabeledFaceDescriptors(d.id.toString(), [new Float32Array(Object.values(d.descriptor))]));
                });
                if(descriptors.length) this.state.faceMatcher = new faceapi.FaceMatcher(descriptors, 0.5);
                this.renderUserList();
            });

            onSnapshot(collection(db, PLACES_COLL), (snap) => {
                this.state.units = [];
                const selectNew = document.getElementById('new-unit-select');
                const selectReport = document.getElementById('report-unit');
                
                selectNew.innerHTML = '<option value="">Selecione...</option>';
                selectReport.innerHTML = '<option value="">Todas as Unidades</option>';
                
                const list = document.getElementById('list-units');
                list.innerHTML = '';

                snap.forEach(doc => {
                    const d = doc.data();
                    this.state.units.push({ docId: doc.id, ...d });
                    selectNew.innerHTML += `<option value="${d.nome}">${d.nome}</option>`;
                    selectReport.innerHTML += `<option value="${d.nome}">${d.nome}</option>`;
                    list.innerHTML += `<div style="padding:8px; border-bottom:1px solid #333;">üè† ${d.nome} <small>(${d.endereco})</small></div>`;
                });
            });
        },

        // --- FLUXO PRINCIPAL ---
        iniciarFluxo: async function(tipo) {
            if(!this.state.modelsLoaded) return alert("IA Carregando...");
            this.state.currentType = tipo;
            document.getElementById('camera-title').innerText = `Registrando: ${tipo}`;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-camera').classList.add('active');
            
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: {} });
                this.state.stream = s;
                this.els.video.srcObject = s;
                this.detectarRosto();
            } catch(e) { alert("Sem c√¢mera!"); this.voltarHome(); }
        },

        detectarRosto: function() {
            const loop = async () => {
                if(!this.state.stream) return;
                const opt = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const det = await faceapi.detectSingleFace(this.els.video, opt).withFaceLandmarks().withFaceDescriptor();
                
                if(det && this.state.faceMatcher) {
                    const match = this.state.faceMatcher.findBestMatch(det.descriptor);
                    if(match.label !== 'unknown') {
                        document.getElementById('feedback-msg').innerText = "Identificado! Processando...";
                        this.processarPonto(match.label);
                        return;
                    }
                }
                requestAnimationFrame(loop);
            };
            loop();
        },

        processarPonto: async function(id) {
            if(this.state.stream) { this.state.stream.getTracks().forEach(t => t.stop()); this.state.stream = null; }
            
            const user = this.state.users.find(u => u.id == id);
            const hoje = new Date().toLocaleDateString('pt-BR');
            const mesAno = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
            
            const q = query(collection(db, LOGS_COLL), where("id", "==", id), where("data", "==", hoje), where("tipo", "==", this.state.currentType));
            const check = await getDocs(q);
            
            if(!check.empty) {
                alert(`‚ö†Ô∏è ATEN√á√ÉO: ${user.nome} j√° registrou '${this.state.currentType}' hoje!`);
                this.voltarHome();
                return;
            }

            // GEOFENCE 50m
            const geo = await this.getGeo();
            const local = this.verificarLocalizacao(geo.lat, geo.lon);

            const reg = {
                id: id, nome: user.nome, tipo: this.state.currentType, unidade: user.unidade,
                data: hoje, hora: new Date().toLocaleTimeString('pt-BR'), mesAno: mesAno,
                lat: geo.lat, lon: geo.lon, localNome: local.nome,
                timestamp: Date.now()
            };
            const ref = await addDoc(collection(db, LOGS_COLL), reg);
            
            this.state.lastReceipt = { ...reg, hash: ref.id.substring(0,8).toUpperCase() };
            document.getElementById('receipt-name').innerText = user.nome;
            document.getElementById('receipt-type').innerText = reg.tipo;
            document.getElementById('receipt-time').innerText = reg.hora;
            document.getElementById('receipt-hash').innerText = this.state.lastReceipt.hash;
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-success').classList.add('active');
        },

        getGeo: function() {
            return new Promise(resolve => {
                if(!navigator.geolocation) resolve({lat:0, lon:0});
                navigator.geolocation.getCurrentPosition(p => resolve({lat:p.coords.latitude, lon:p.coords.longitude}), () => resolve({lat:0,lon:0}), {enableHighAccuracy:true});
            });
        },

        verificarLocalizacao: function(lat, lng) {
            const TOLERANCIA = 50; // 50 METROS
            for(let u of this.state.units) {
                const dist = this.getDistanceFromLatLonInKm(lat, lng, u.lat, u.lon);
                if(dist <= TOLERANCIA) return { nome: u.nome, autorizado: true };
            }
            return { nome: "EXTERNO", autorizado: false };
        },

        getDistanceFromLatLonInKm: function(lat1, lon1, lat2, lon2) {
            const R = 6371; const dLat = this.deg2rad(lat2-lat1); const dLon = this.deg2rad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(this.deg2rad(lat1))*Math.cos(this.deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))) * 1000;
        },
        deg2rad: (deg) => deg * (Math.PI/180),

        cancelarFluxo: function() {
            if(this.state.stream) this.state.stream.getTracks().forEach(t => t.stop());
            this.voltarHome();
        },
        voltarHome: function() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-home').classList.add('active');
        },
        baixarComprovante: function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`COMPROVANTE MARANATIME`, 20, 20);
            doc.text(`-----------------------`, 20, 30);
            doc.text(`Colaborador: ${this.state.lastReceipt.nome}`, 20, 40);
            doc.text(`A√ß√£o: ${this.state.lastReceipt.tipo}`, 20, 50);
            doc.text(`Data: ${this.state.lastReceipt.data} - ${this.state.lastReceipt.hora}`, 20, 60);
            doc.text(`Local: ${this.state.lastReceipt.localNome}`, 20, 70);
            doc.text(`HASH: ${this.state.lastReceipt.hash}`, 20, 90);
            doc.save('comprovante.pdf');
        },

        // --- ADMIN ---
        abrirLoginAdmin: () => document.getElementById('modal-login').classList.add('active'),
        loginAdmin: function() {
            if(document.getElementById('admin-pass').value === '123') {
                document.getElementById('modal-login').classList.remove('active');
                document.getElementById('modal-admin').classList.add('active');
                this.iniciarCamAdmin();
                this.gerarIdAleatorio();
            } else alert("Senha errada.");
        },
        sairAdmin: function() {
            document.getElementById('modal-admin').classList.remove('active');
            if(this.state.adminStream) this.state.adminStream.getTracks().forEach(t=>t.stop());
        },
        iniciarCamAdmin: async function() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({video:{}});
                this.state.adminStream = s;
                this.els.videoAdm.srcObject = s;
            } catch(e){}
        },
        mudarAba: function(aba) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-tab-${aba}`).classList.add('active');
            ['cadastro','unidades','registros','relatorios'].forEach(t => document.getElementById(`tab-${t}`).style.display = 'none');
            document.getElementById(`tab-${aba}`).style.display = 'block';
            if(aba === 'registros') this.carregarLogsAdmin();
        },
        gerarIdAleatorio: function() {
            document.getElementById('new-id').value = Math.floor(100000 + Math.random() * 900000);
        },

        // --- SALVAR (COM DUPLICIDADE E LOADING) ---
        salvarColaborador: async function() {
            const btn = this.els.btnSaveUser;
            const nome = document.getElementById('new-name').value.trim();
            const id = document.getElementById('new-id').value;
            const unidade = document.getElementById('new-unit-select').value;
            const inicio = document.getElementById('new-start').value;

            if(!nome || !unidade) return alert("Preencha Nome e Unidade.");
            const duplicado = this.state.users.find(u => u.nome.toLowerCase() === nome.toLowerCase());
            if(duplicado) return alert("‚ùå Nome j√° existe!");

            btn.classList.add('loading');
            btn.disabled = true;

            try {
                const det = await faceapi.detectSingleFace(this.els.videoAdm, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                if(!det) throw new Error("Rosto n√£o detectado!");

                await addDoc(collection(db, USERS_COLL), {
                    id: id, nome: nome, unidade: unidade, horarioEntrada: inicio,
                    scale: document.getElementById('new-scale').value,
                    descriptor: { ...det.descriptor }
                });

                alert("‚úÖ Cadastro Realizado!");
                this.limparFormulario('user');
            } catch(e) { alert("Erro: " + e.message); } 
            finally { btn.classList.remove('loading'); btn.disabled = false; }
        },

        salvarUnidade: async function() {
            const btn = this.els.btnSaveUnit;
            const nome = document.getElementById('unit-name').value.trim();
            if(!nome) return alert("Preencha o Nome.");
            const duplicado = this.state.units.find(u => u.nome.toLowerCase() === nome.toLowerCase());
            if(duplicado) return alert("‚ùå Unidade j√° existe!");

            btn.classList.add('loading');
            btn.disabled = true;

            try {
                await addDoc(collection(db, PLACES_COLL), {
                    nome: nome, endereco: document.getElementById('unit-address').value,
                    lat: document.getElementById('unit-lat').value, lon: document.getElementById('unit-lon').value
                });
                alert("‚úÖ Unidade Salva!");
                this.limparFormulario('unit');
            } catch(e) { alert("Erro ao salvar."); }
            finally { btn.classList.remove('loading'); btn.disabled = false; }
        },

        obterGPSAtual: function() {
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('unit-lat').value = p.coords.latitude;
                document.getElementById('unit-lon').value = p.coords.longitude;
            });
        },

        limparFormulario: function(tipo) {
            if(tipo === 'user') {
                document.getElementById('new-name').value = "";
                document.getElementById('new-start').value = "";
                document.getElementById('new-end').value = "";
                this.gerarIdAleatorio();
            } else {
                document.getElementById('unit-name').value = "";
                document.getElementById('unit-address').value = "";
            }
        },

        renderUserList: function() {
            document.getElementById('list-users').innerHTML = this.state.users.map(u => `<div>üë§ ${u.nome} (ID: ${u.id})</div>`).join('');
        },

        // --- HIST√ìRICO E GEST√ÉO DE PONTOS ---
        carregarLogsAdmin: function() {
            const tbody = document.getElementById('tbody-logs');
            tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            
            const hoje = new Date().toLocaleDateString('pt-BR');
            const q = query(collection(db, LOGS_COLL), where("data", "==", hoje));
            
            onSnapshot(q, (snap) => {
                let html = "";
                if(snap.empty) { tbody.innerHTML = "<tr><td colspan='5'>Sem registros hoje.</td></tr>"; return; }

                snap.forEach(doc => {
                    const d = doc.data();
                    const docId = doc.id;
                    const user = this.state.users.find(u => u.id == d.id);
                    
                    let statusClass = "";
                    let statusText = d.adminStatus ? (d.adminStatus === 'bonificado' ? 'ABONADO' : 'JUSTIFICADO') : 'Normal';
                    
                    if (d.adminStatus) {
                        statusClass = "ok";
                    } else if (d.tipo === 'Entrada' && user && user.horarioEntrada) {
                        const [hC, mC] = user.horarioEntrada.split(':').map(Number);
                        const [hR, mR] = d.hora.split(':').map(Number);
                        if ((hR * 60 + mR) > (hC * 60 + mC) + 10) { statusClass = "late"; statusText = "ATRASO"; }
                    }

                    const botoes = `
                        <button class="primary btn-small" style="background:var(--success)" onclick="app.abonarPonto('${docId}')">‚úÖ</button>
                        <button class="primary btn-small" style="background:var(--warning); color:black;" onclick="app.abrirJustificativa('${docId}', '${d.nome}')">üìù</button>
                    `;

                    html += `<tr class="${statusClass}"><td>${d.nome}</td><td>${d.tipo}</td><td>${d.hora}</td><td>${statusText} ${d.adminNote ? '<br><small>('+d.adminNote+')</small>' : ''}</td><td>${botoes}</td></tr>`;
                });
                tbody.innerHTML = html;
            });
        },

        abonarPonto: async function(docId) {
            if(confirm("Deseja ABONAR este ponto?")) {
                await updateDoc(doc(db, LOGS_COLL, docId), { adminStatus: 'bonificado', adminNote: 'Abonado pelo Gestor' });
            }
        },

        abrirJustificativa: function(docId, nome) {
            document.getElementById('justify-doc-id').value = docId;
            document.getElementById('justify-info').innerText = `Colaborador: ${nome}`;
            document.getElementById('justify-text').value = "";
            document.getElementById('modal-justify').classList.add('active');
        },

        salvarJustificativa: async function() {
            const docId = document.getElementById('justify-doc-id').value;
            const texto = document.getElementById('justify-text').value;
            if(!texto) return alert("Digite o motivo.");
            await updateDoc(doc(db, LOGS_COLL, docId), { adminStatus: 'justificado', adminNote: texto });
            document.getElementById('modal-justify').classList.remove('active');
        },

        // --- RELAT√ìRIOS ---
        imprimirRelatorioFechamento: async function() {
            const mesInput = document.getElementById('report-month').value;
            const unidade = document.getElementById('report-unit').value;
            if(!mesInput) return alert("Selecione o m√™s.");

            const q = query(collection(db, LOGS_COLLECTION));
            const snap = await getDocs(q);
            const pontos = [];
            snap.forEach(d => { if(d.data().mesAno === mesInput) pontos.push(d.data()) });
            
            const filtrados = unidade ? pontos.filter(p => p.unidade === unidade) : pontos;
            
            // FORMATA√á√ÉO DO T√çTULO E DATA
            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const [ano, mesNum] = mesInput.split('-');
            const mesNome = meses[parseInt(mesNum)-1];
            
            const tituloRelatorio = `Fechamento - ${mesNome}/${ano} - ${unidade || 'Geral'}`;
            const nomeEmpresa = unidade ? `${COMPANY_BASE_INFO.nome} - ${unidade.toUpperCase()}` : COMPANY_BASE_INFO.nome;

            // AGRUPAR DADOS (Exemplo Simplificado para Relat√≥rio)
            let html = "";
            filtrados.forEach(p => {
                html += `<tr><td>${p.nome}</td><td>${p.data}</td><td>${p.tipo}</td><td>${p.hora}</td></tr>`;
            });

            this.gerarImpressao(tituloRelatorio, nomeEmpresa, html, ["Nome", "Data", "Tipo", "Hora"]);
        },

        imprimirRelatorioDetalhado: async function() {
            // Reutiliza l√≥gica similar ou cria espec√≠fica
            this.imprimirRelatorioFechamento(); 
        },

        gerarImpressao: function(titulo, empresa, linhas, headers) {
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head>
                    <title>${titulo}</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top:20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        th { background: #eee; }
                        @media print { .no-print { display: none !important; } }
                        .btn-print { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
                        .btn-print:hover { background: #0284c7; }
                    </style>
                </head>
                <body>
                    <button class="btn-print no-print" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                    
                    <div style="text-align:center; border-bottom: 2px solid #0ea5e9; padding-bottom: 10px; margin-bottom: 20px;">
                        <h2>${empresa}</h2>
                        <p>CNPJ: 05.284.121/0001-26 | ${COMPANY_BASE_INFO.contato}</p>
                    </div>
                    
                    <h3 style="text-align:center; background:#f0f9ff; padding:10px; border-radius:8px;">${titulo}</h3>
                    
                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>${linhas}</tbody>
                    </table>
                </body>
                </html>
            `);
            win.document.close();
        }
    };

    window.app = app;
    window.onload = () => app.init();
</script>
</body>
</html>