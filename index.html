<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maranata App - Comprovante Digital</title>
    <style>
        /* --- ESTILO BASE --- */
        :root {
            --primary: #00695c;
            --accent: #00e676;
            --white: #ffffff;
            --bg-dark: #050505;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-dark); color: white; overflow: hidden; height: 100vh; width: 100vw; }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(160deg, #004d40 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
        }
        .login-box {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(20px);
            padding: 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; width: 85%; max-width: 350px;
        }
        .login-box input {
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 50px; border: none;
            background: rgba(255,255,255,0.9); font-size: 16px; text-align: center; outline: none;
        }
        .btn-login {
            width: 100%; padding: 15px; background: var(--primary); color: white;
            border: none; border-radius: 50px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px;
        }

        /* --- MENU SCROLL --- */
        #main-menu { display: none; height: 100vh; width: 100vw; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        #main-menu::-webkit-scrollbar { display: none; }

        .fixed-header {
            position: fixed; top: 0; width: 100%; padding-top: 25px; text-align: center; z-index: 1000;
            pointer-events: none; text-shadow: 0 2px 10px black;
        }
        .fixed-header h2 { font-weight: 300; font-size: 20px; color: #fff; }

        .scroll-section {
            height: 100vh; width: 100vw; scroll-snap-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative;
        }
        
        /* Bot√µes Scroll */
        .circle-btn {
            width: 200px; height: 200px; border-radius: 50%; border: none; color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6), inset 0 0 30px rgba(255,255,255,0.1);
            position: relative; z-index: 10; text-transform: uppercase; letter-spacing: 1px;
            transition: transform 0.2s;
        }
        .circle-btn:active { transform: scale(0.95); }
        
        .btn-entrada { background: linear-gradient(135deg, #2e7d32, #1b5e20); border: 2px solid #4caf50; }
        .btn-pausa { background: linear-gradient(135deg, #f9a825, #f57f17); border: 2px solid #fbc02d; }
        .btn-retorno { background: linear-gradient(135deg, #0277bd, #01579b); border: 2px solid #039be5; }
        .btn-fim { background: linear-gradient(135deg, #c62828, #b71c1c); border: 2px solid #ef5350; }

        .hint { position: absolute; bottom: 40px; opacity: 0.5; font-size: 12px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-10px);} }

        /* --- C√ÇMERA IA --- */
        #camera-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 3000; flex-direction: column; justify-content: center; align-items: center;
        }
        .camera-viewport { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .face-silhouette {
            position: absolute; width: 280px; height: 380px;
            border: 2px dashed rgba(255, 255, 255, 0.4); border-radius: 50% 50% 45% 45%;
            box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.85); z-index: 10; transition: all 0.5s ease;
        }
        .face-silhouette.scanning { border-color: var(--accent); border-style: solid; box-shadow: 0 0 30px var(--accent), 0 0 0 100vmax rgba(0,0,0,0.9); }

        .status-msg {
            position: absolute; bottom: 100px; width: 100%; text-align: center; z-index: 20;
            color: white; text-shadow: 0 2px 5px black;
        }
        .status-msg h3 { font-size: 24px; margin-bottom: 5px; }

        /* --- POPUP JUSTIFICATIVA --- */
        #justificativa-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3500;
            justify-content: center; align-items: center;
        }
        .just-box {
            background: #1e1e1e; width: 90%; max-width: 350px; padding: 25px;
            border-radius: 15px; border: 1px solid #ffb300; text-align: center;
            box-shadow: 0 10px 30px black;
        }
        .just-box textarea {
            width: 100%; height: 80px; background: #333; border: 1px solid #555; color: white;
            padding: 10px; border-radius: 8px; font-size: 14px; margin-bottom: 15px; resize: none;
        }
        .btn-confirm-just {
            width: 100%; padding: 12px; background: #ffb300; color: black; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
        }

        /* --- TELA FINAL (SUCESSO + COMPROVANTE) --- */
        #success-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1b5e20 0%, #004d40 100%); z-index: 4000;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
        }
        .check-circle {
            width: 100px; height: 100px; border-radius: 50%; background: white;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 30px; animation: scaleUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .check-circle span { font-size: 60px; color: #1b5e20; }
        
        @keyframes scaleUp { from{transform:scale(0);} to{transform:scale(1);} }

        .success-actions {
            display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; margin-top: 40px;
        }
        
        .btn-download {
            background: rgba(255,255,255,0.2); border: 2px solid white; color: white;
            padding: 15px; border-radius: 30px; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        .btn-download:hover { background: white; color: #1b5e20; }
        
        .btn-ok {
            background: white; color: #1b5e20; border: none;
            padding: 15px; border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-ok:hover { transform: scale(1.05); }

    </style>
</head>
<body onload="initSystem()">

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px;">üíé</div>
            <h2>MARANATA</h2>
            <input type="text" id="user" placeholder="ID Usu√°rio">
            <input type="password" id="pass" placeholder="Senha">
            <button class="btn-login" onclick="login()">ENTRAR</button>
        </div>
    </div>

    <div id="main-menu">
        <div class="fixed-header">
            <h2>O que deseja registrar?</h2>
            <p style="font-size:12px; color:#aaa;">Role para selecionar</p>
        </div>

        <section class="scroll-section" style="background: radial-gradient(circle, #002200 0%, #000 70%);">
            <button class="circle-btn btn-entrada" onclick="iniciarProcesso('ENTRADA')">
                <div style="font-size:40px">‚òÄÔ∏è</div> Entrada
            </button>
            <div class="hint">‚ñº Pausa</div>
        </section>

        <section class="scroll-section" style="background: radial-gradient(circle, #332200 0%, #000 70%);">
            <button class="circle-btn btn-pausa" onclick="iniciarProcesso('IN√çCIO PAUSA')">
                <div style="font-size:40px">‚òï</div> In√≠cio Pausa
            </button>
            <div class="hint">‚ñº Retorno</div>
        </section>

        <section class="scroll-section" style="background: radial-gradient(circle, #001133 0%, #000 70%);">
            <button class="circle-btn btn-retorno" onclick="iniciarProcesso('RETORNO PAUSA')">
                <div style="font-size:40px">üîô</div> Retorno Pausa
            </button>
            <div class="hint">‚ñº Fim</div>
        </section>

        <section class="scroll-section" style="background: radial-gradient(circle, #330000 0%, #000 70%);">
            <button class="circle-btn btn-fim" onclick="iniciarProcesso('FIM EXPEDIENTE')">
                <div style="font-size:40px">üåô</div> Fim Expediente
            </button>
        </section>
    </div>

    <div id="camera-modal">
        <div class="camera-viewport">
            <video id="video-feed" autoplay playsinline muted></video>
            <div class="face-silhouette" id="silhouette"></div>
            <div class="status-msg">
                <h3 id="ia-status">Buscando Rosto...</h3>
                <p id="ia-details">Posicione-se na silhueta</p>
            </div>
        </div>
    </div>

    <div id="justificativa-modal">
        <div class="just-box">
            <h3>‚ö†Ô∏è Ponto Externo</h3>
            <p>Voc√™ est√° fora da cerca virtual da Sede.<br>Descreva o motivo:</p>
            <textarea id="txt-motivo" placeholder="Motivo..."></textarea>
            <button class="btn-confirm-just" onclick="confirmarJustificativa()">CONFIRMAR E REGISTRAR</button>
        </div>
    </div>

    <div id="success-screen">
        <div class="check-circle">
            <span>‚úì</span>
        </div>
        <h2 style="font-size:28px; margin-bottom:5px;">REGISTRADO!</h2>
        <p style="opacity:0.8;">Seu ponto foi computado com sucesso.</p>
        
        <div class="success-actions">
            <button class="btn-download" onclick="baixarComprovante()">
                üìÑ Baixar Comprovante
            </button>

            <button class="btn-ok" onclick="voltarParaMenu()">
                OK (Voltar ao In√≠cio)
            </button>
        </div>
    </div>

    <script>
        // CONFIG
        const SEDE_LAT = -22.9035; 
        const SEDE_LNG = -43.2800; 
        const RAIO_METROS = 50; 
        
        // DADOS DA SESS√ÉO
        let stream = null;
        let tipoAtual = "";
        let usuarioAtual = "";
        let estaDentro = false;
        let registroFinal = {}; // Guarda dados para o comprovante

        function initSystem() { console.log("Sistema Pronto"); }

        function login() {
            const u = document.getElementById('user').value;
            if(u) {
                usuarioAtual = u;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-menu').style.display = 'block';
            } else { alert("Login obrigat√≥rio"); }
        }

        // --- 1. CLIQUE / IN√çCIO ---
        function iniciarProcesso(tipo) {
            tipoAtual = tipo;
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = "üõ∞Ô∏è Verificando...";

            if(!navigator.geolocation) {
                alert("GPS Obrigat√≥rio!");
                btn.innerHTML = originalHTML;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const dist = calcularDist(pos.coords.latitude, pos.coords.longitude, SEDE_LAT, SEDE_LNG);
                    estaDentro = (dist <= RAIO_METROS);
                    
                    // Salva dados parciais
                    registroFinal = {
                        data: new Date(),
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        local: estaDentro ? "SEDE ADMINISTRATIVA" : "LOCAL EXTERNO",
                        justificativa: estaDentro ? "Registro Normal" : ""
                    };

                    btn.innerHTML = originalHTML;
                    abrirCameraIA();
                },
                (err) => {
                    alert("Erro GPS.");
                    btn.innerHTML = originalHTML;
                }
            );
        }

        // --- 2. C√ÇMERA IA ---
        async function abrirCameraIA() {
            const modal = document.getElementById('camera-modal');
            const h3 = document.getElementById('ia-status');
            const silhueta = document.getElementById('silhouette');

            modal.style.display = 'flex';
            h3.innerText = "Buscando Rosto..."; h3.style.color="white";
            silhueta.classList.remove('scanning');

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('video-feed').srcObject = stream;

                setTimeout(() => {
                    h3.innerText = "Analisando...";
                    silhueta.classList.add('scanning');
                }, 1500);

                setTimeout(() => {
                    h3.innerText = "ROSTO IDENTIFICADO";
                    h3.style.color = "#00e676";
                    
                    setTimeout(() => {
                        fecharCamera();
                        verificarDestino(); // Decis√£o
                    }, 1500);
                }, 3500);

            } catch (err) {
                alert("Erro C√¢mera: " + err.message);
                modal.style.display = 'none';
            }
        }

        function fecharCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            if(stream) stream.getTracks().forEach(t => t.stop());
        }

        // --- 3. DECIS√ÉO E JUSTIFICATIVA ---
        function verificarDestino() {
            if (estaDentro) {
                exibirTelaSucesso();
            } else {
                abrirPopupJustificativa();
            }
        }

        function abrirPopupJustificativa() {
            document.getElementById('txt-motivo').value = "";
            document.getElementById('justificativa-modal').style.display = 'flex';
        }

        function confirmarJustificativa() {
            const motivo = document.getElementById('txt-motivo').value;
            if(motivo.length < 3) { alert("Justifique!"); return; }
            
            registroFinal.justificativa = motivo;
            document.getElementById('justificativa-modal').style.display = 'none';
            exibirTelaSucesso();
        }

        // --- 4. TELA FINAL (BOTOES DE A√á√ÉO) ---
        function exibirTelaSucesso() {
            // Preenche dados finais (Hora exata do registro)
            registroFinal.data = new Date();
            
            const screen = document.getElementById('success-screen');
            screen.style.display = 'flex';
        }

        // A√á√ÉO: VOLTAR PARA O IN√çCIO
        function voltarParaMenu() {
            document.getElementById('success-screen').style.display = 'none';
            // O sistema j√° est√° resetado pois a c√¢mera fechou e vari√°veis locais foram usadas.
            // O app volta ao estado de espera no menu de scroll.
        }

        // A√á√ÉO: BAIXAR COMPROVANTE (TIPO CUPOM FISCAL)
        function baixarComprovante() {
            const dt = registroFinal.data;
            const dia = dt.toLocaleDateString('pt-BR');
            const hora = dt.toLocaleTimeString('pt-BR');
            
            // Layout do "Papelzinho"
            const textoComprovante = `
================================
    ASSOCIA√á√ÉO MARANATA RH    
      Comprovante de Ponto      
================================
CNPJ: 26.123.456/0001-00
--------------------------------
COLABORADOR: ${usuarioAtual.toUpperCase()}
DATA: ${dia}
HORA: ${hora}
TIPO: ${tipoAtual}
--------------------------------
STATUS: ${registroFinal.local}
${!estaDentro ? "JUSTIFICATIVA: " + registroFinal.justificativa : ""}
--------------------------------
ID REGISTRO: ${Math.floor(Math.random() * 100000000)}
AUTENTICA√á√ÉO: ${btoa(usuarioAtual + hora).substring(0, 15)}
================================
   Guardar para confer√™ncia.    
`;

            // Cria o arquivo TXT para download
            const blob = new Blob([textoComprovante], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.download = `Comprovante_Maranata_${dia.replace(/\//g,'-')}_${hora}.txt`;
            link.click();
        }

        // --- UTILS ---
        function calcularDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180, ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>