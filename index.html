<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MaranaTime Cloud - Sistema Integrado</title>
    <!-- Face API -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --primary: #1e3a8a; --primary-light: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc;
            --card-bg: #ffffff; --text: #1e293b; --border: #e2e8f0;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        html, body { height: 100%; width: 100%; background: var(--bg); color: var(--text); overflow: hidden; }
        .app-container { height: 100%; width: 100%; max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; padding: 10px; }
        
        /* Header & Nav */
        .main-header { text-align: center; margin-bottom: 10px; flex-shrink: 0; }
        .logo-area h1 { color: var(--primary); font-size: 1.5rem; margin: 0; }
        .logo-area p { font-size: 0.8rem; color: #64748b; }
        .status-bar { font-size: 0.7rem; font-weight: bold; margin-top: 2px; display: flex; justify-content: center; gap: 10px; }
        .status-item { padding: 2px 8px; border-radius: 10px; background: #e2e8f0; color: #64748b; }
        .status-item.online { background: #dcfce7; color: #166534; }
        .nav-bar { display: flex; gap: 10px; margin-bottom: 10px; background: #e2e8f0; padding: 5px; border-radius: 8px; flex-shrink: 0; }
        .nav-btn { flex: 1; padding: 8px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #64748b; border-radius: 6px; transition: 0.2s; font-size: 0.9rem; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Sections */
        .view-section { display: none; flex: 1; overflow: hidden; position: relative; }
        .view-section.active { display: flex; flex-direction: column; }
        #view-ponto.active { justify-content: center; align-items: center; }
        #view-admin.active { overflow-y: auto; display: block; padding-bottom: 20px; }

        /* Components */
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border); width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; }
        #view-admin .card { max-width: 100%; display: block; }
        
        .camera-container { position: relative; width: auto; height: 40vh; max-height: 400px; aspect-ratio: 3/4; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #ai-overlay { display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }

        /* Feedback Visual */
        #success-message, #error-message {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px; border-radius: 12px; text-align: center; z-index: 20; width: 80%; 
            font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: fadeUp 0.3s;
        }
        #success-message { background: rgba(34, 197, 94, 0.95); color: white; }
        #error-message { background: rgba(239, 68, 68, 0.95); color: white; }

        .input-group { margin-bottom: 10px; width: 100%; }
        label { display: block; margin-bottom: 2px; font-weight: 600; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; }
        
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; font-size: 1rem; width: 100%; padding: 12px; }
        button:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background: var(--primary-light); color: white; padding: 8px 15px; width: auto; }
        .btn-success { background: var(--success); color: white; width: auto; }
        .btn-danger { background: var(--danger); color: white; width: auto; }
        .btn-danger.small { font-size: 0.8rem; padding: 5px 10px; }
        .btn-purple { background: #8b5cf6; color: white; width: auto; }
        .btn-edit { background: #f59e0b; color: white; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; width: auto; margin-right: 5px;}

        /* Admin & Tables */
        .filters-area { background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
        .filter-item { flex: 1; min-width: 140px; }
        .actions-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .form-row { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 5px; margin-top: 5px; align-items: end; }
        
        .table-responsive { overflow-x: auto; margin-top: 10px; max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th { background: #e2e8f0; position: sticky; top: 0; z-index: 10; font-weight: 700; color: var(--primary); }
        .mini-photo { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid white; }

        /* Modais (Padr√£o e Customizados) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; animation: fadeUp 0.2s; }
        .modal-card { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        
        /* --- NOVO ESTILO DE ERRO PARA JANELA --- */
        .modal-card.error-style {
            background-color: #fee2e2;
            border: 2px solid #ef4444;
        }
        .modal-card.error-style .alert-title {
            color: #b91c1c;
        }
        .modal-card.error-style .alert-msg {
            color: #7f1d1d;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .modal-card.error-style button {
            background-color: #ef4444;
            color: white;
            border: none;
        }
        .modal-card.error-style button:hover {
            background-color: #dc2626;
        }

        .alert-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; display: block; color: var(--primary); }
        .alert-msg { color: #333; margin-bottom: 20px; display: block; }

        hr { border: 0; border-top: 1px solid var(--border); margin: 15px 0; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @media(max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="app-container">
    <header class="main-header">
        <div class="logo-area">
            <h1>‚òÅÔ∏è MaranaTime Cloud</h1>
            <p>Sistema Integrado - 16 Filiais</p>
        </div>
        <div class="status-bar">
            <span id="ia-status" class="status-item">IA: Carregando...</span>
            <span id="db-status" class="status-item">Nuvem: Conectando...</span>
        </div>
    </header>

    <nav class="nav-bar">
        <button onclick="window.app.switchTab('ponto')" id="btn-ponto" class="nav-btn active">üïí Ponto</button>
        <button onclick="window.app.switchTab('admin')" id="btn-admin" class="nav-btn">üõ†Ô∏è Gest√£o</button>
    </nav>

    <!-- ABA 1: FUNCION√ÅRIO -->
    <section id="view-ponto" class="view-section active">
        <div class="card">
            <h2 style="color: var(--primary); font-size: 1.2rem; margin-bottom: 5px;">Reconhecimento Facial</h2>
            <div class="camera-container">
                <video id="video-feed" autoplay playsinline muted></video>
                <canvas id="ai-overlay"></canvas>
                
                <!-- Mensagem Sucesso (Overlay) -->
                <div id="success-message">
                    <div style="font-size: 3rem;">‚úÖ</div>
                    <div id="success-text">Ponto Registrado!</div>
                </div>
                <!-- Mensagem Erro (Overlay) -->
                <div id="error-message">
                    <div style="font-size: 3rem;">‚ö†Ô∏è</div>
                    <div id="error-text">Duplicado!</div>
                </div>
            </div>
            <div class="input-group">
                <label>üÜî ID / Matr√≠cula</label>
                <input type="number" id="employee-id" placeholder="Digite ID">
            </div>
            <div class="input-group">
                <label>üìå A√ß√£o</label>
                <select id="punch-type">
                    <option value="Entrada">üü¢ Entrada</option>
                    <option value="Sa√≠da Almo√ßo">üçΩÔ∏è Sa√≠da Almo√ßo</option>
                    <option value="Volta Almo√ßo">üîô Volta Almo√ßo</option>
                    <option value="Fim Expediente">üî¥ Fim Expediente</option>
                </select>
            </div>
            <!-- BOT√ÉO REMOVIDO CONFORME SOLICITADO -->
        </div>
    </section>

    <!-- ABA 2: ADMINISTRA√á√ÉO -->
    <section id="view-admin" class="view-section">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2>Painel Matriz</h2>
                <button onclick="window.app.logoutAdmin()" class="btn-danger small">üîí Sair</button>
            </div>

            <!-- CADASTRO -->
            <div class="input-group" style="background: #e0f2fe; padding: 10px; border-radius: 8px;">
                <h3 style="color: var(--primary); margin: 0; font-size: 1rem;">üë§ Novo Cadastro (Global)</h3>
                <div class="camera-container" style="height: 150px; margin: 5px auto; width: 112px;"> 
                    <video id="admin-video-feed" autoplay playsinline muted></video>
                </div>
                <div class="form-row">
                    <div><label>ID</label><input type="number" id="new-user-id"></div>
                    <div><label>Nome</label><input type="text" id="new-user-name"></div>
                    <div><label>Unidade</label><input type="text" id="new-user-unit" placeholder="Ex: Filial 3"></div>
                    <div><label>Horas/Sem</label><input type="number" id="new-user-hours" value="44"></div>
                </div>
                <button onclick="window.app.cadastrarBiometria()" class="btn-primary" style="margin-top: 5px;">Salvar na Nuvem</button>
            </div>

            <hr>

            <!-- LISTA DE FUNCION√ÅRIOS -->
            <div class="input-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 1rem;">Base de Colaboradores</h3>
                    <select id="filter-employees-unit" onchange="window.app.renderizarListaFuncionarios()" style="width: 120px; padding: 5px;">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="table-responsive" style="max-height: 200px;">
                    <table id="employees-table">
                        <thead><tr><th>ID</th><th>Nome</th><th>Unid.</th><th>Hrs</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="employees-tbody"></tbody>
                    </table>
                </div>
            </div>

            <hr>

            <!-- RELAT√ìRIOS -->
            <div class="filters-area">
                <label style="font-weight:bold;">Relat√≥rios Oficiais (Papel Timbrado):</label>
                <div class="filter-row">
                    <div class="filter-item"><input type="month" id="admin-month-filter"></div>
                    <div class="filter-item"><select id="admin-unit-filter"><option value="">Todas</option></select></div>
                    <div class="filter-item"><button onclick="window.app.carregarTabelaPontos()" class="btn-secondary">Listar na Tela</button></div>
                </div>
                <div class="actions-row">
                    <button onclick="window.app.imprimirRelatorioDetalhado()" class="btn-success">üñ®Ô∏è Imprimir Detalhado</button>
                    <button onclick="window.app.imprimirRelatorioFechamento()" class="btn-purple">üñ®Ô∏è Imprimir Fechamento</button>
                </div>
            </div>

            <div class="logs-area">
                <h3 style="font-size: 1rem;">Hist√≥rico Recente</h3>
                <div class="table-responsive">
                    <table id="logs-table">
                        <thead><tr><th>Data</th><th>Hora</th><th>ID</th><th>Nome</th><th>Unid</th><th>Tipo</th></tr></thead>
                        <tbody id="logs-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- MODAIS -->
<div id="modal-login" class="modal-overlay"><div class="modal-card"><h3>üîí Login Admin</h3><div class="input-group"><label>Usu√°rio</label><input type="text" id="login-user" autocomplete="off"></div><div class="input-group"><label>Senha</label><input type="password" id="login-pass" autocomplete="new-password"></div><div class="modal-actions"><button onclick="window.app.verificarLogin()" class="btn-primary">Entrar</button><button onclick="window.app.fecharLogin()" class="btn-danger">Cancelar</button></div></div></div>
<div id="modal-edit" class="modal-overlay"><div class="modal-card"><h3>‚úèÔ∏è Editar</h3><input type="hidden" id="edit-user-id-hidden"><div class="input-group"><label>Nome</label><input type="text" id="edit-user-name"></div><div class="input-group"><label>Unidade</label><input type="text" id="edit-user-unit"></div><div class="input-group"><label>Carga Hor√°ria</label><input type="number" id="edit-user-hours"></div><div class="modal-actions"><button onclick="window.app.salvarEdicao()" class="btn-success">Salvar na Nuvem</button><button onclick="document.getElementById('modal-edit').classList.remove('active')" class="btn-danger">Cancelar</button></div></div></div>

<!-- NOVO: MODAIS DE ALERTA E CONFIRMA√á√ÉO PERSONALIZADOS -->
<div id="custom-alert" class="modal-overlay">
    <div class="modal-card" style="text-align: center;">
        <span class="alert-title" id="alert-title">Aviso</span>
        <span class="alert-msg" id="alert-msg">Mensagem aqui</span>
        <button onclick="window.app.fecharAlert()" class="btn-primary" style="width: 50%; margin: 0 auto; display: block;">OK</button>
    </div>
</div>

<div id="custom-confirm" class="modal-overlay">
    <div class="modal-card" style="text-align: center;">
        <span class="alert-title">Confirma√ß√£o</span>
        <span class="alert-msg" id="confirm-msg">Tem certeza?</span>
        <div class="modal-actions">
            <button id="confirm-yes" class="btn-danger">Sim</button>
            <button onclick="window.app.fecharConfirm()" class="btn-secondary">N√£o</button>
        </div>
    </div>
</div>

<canvas id="capture-canvas" style="display:none;"></canvas>

<!-- CONFIGURA√á√ÉO FIREBASE - M√ìDULO -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- L√ìGICA DE SELE√á√ÉO DE AMBIENTE ---
    let firebaseConfig;
    let USERS_COLLECTION;
    let LOGS_COLLECTION;
    let APP_ID = 'default';

    if (typeof __firebase_config !== 'undefined') {
        // MODO PREVIEW
        firebaseConfig = JSON.parse(__firebase_config);
        APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default';
        USERS_COLLECTION = `artifacts/${APP_ID}/public/data/users`;
        LOGS_COLLECTION = `artifacts/${APP_ID}/public/data/logs`;
        console.log("Modo Preview Ativado");
    } else {
        // MODO PRODU√á√ÉO (GitHub)
        firebaseConfig = {
            apiKey: "AIzaSyBDBx51fCm4lwnSyDC3uIZ-jc7wKM7oTjQ",
            authDomain: "maranatime.firebaseapp.com",
            projectId: "maranatime",
            storageBucket: "maranatime.firebasestorage.app",
            messagingSenderId: "738069003904",
            appId: "1:738069003904:web:cc1ca9a2e2f5545f9c7065",
            measurementId: "G-KTT686MYJ0"
        };
        USERS_COLLECTION = "users";
        LOGS_COLLECTION = "logs";
        console.log("Modo Produ√ß√£o Ativado");
    }
    
    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    // --- DADOS DO PAPEL TIMBRADO ---
    const COMPANY_INFO = {
        nome: "ASSOCIA√á√ÉO MARANATH√Å DO RIO DE JANEIRO",
        endereco: "Rua: Adolfo Bergamini, 199 - Engenho de Dentro - Rio de Janeiro - RJ",
        contato: "CEP 20730-000 - Tel.: (21) 3795-8324, 3439-0385",
        cnpj_site: "CNPJ: 05.284.121/0001-26 - www.maranathario.com"
    };

    // --- L√ìGICA DA APLICA√á√ÉO ---
    const app = {
        adminConfig: { user: "admin", pass: "123" },
        adminLogado: false,
        funcionariosCache: [],
        modelosCarregados: false,
        streamAtiva: null,
        faceMatcher: null,
        ultimoRegistro: 0,
        confirmCallback: null,

        els: {
            videoMain: document.getElementById('video-feed'),
            videoAdmin: document.getElementById('admin-video-feed'),
            overlay: document.getElementById('ai-overlay'),
            canvas: document.getElementById('capture-canvas'),
            statusIA: document.getElementById('ia-status'),
            statusDB: document.getElementById('db-status'),
            // BOT√ÉO REMOVIDO
            employeeIdInput: document.getElementById('employee-id'),
            successMessage: document.getElementById('success-message'),
            successText: document.getElementById('success-text'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            
            modalLogin: document.getElementById('modal-login'),
            modalEdit: document.getElementById('modal-edit'),
            modalAlert: document.getElementById('custom-alert'),
            modalConfirm: document.getElementById('custom-confirm'),
            
            dateFilter: document.getElementById('admin-month-filter'),
            unitFilter: document.getElementById('admin-unit-filter'),
            employeesUnitFilter: document.getElementById('filter-employees-unit')
        },

        init: async function() {
            this.els.statusDB.innerText = "Nuvem: Iniciando...";
            try {
                await signInAnonymously(auth);
                this.els.statusDB.innerText = "Nuvem: Conectada üü¢";
                this.els.statusDB.classList.add('online');
                this.sincronizarFuncionarios();
            } catch (error) {
                console.error("Erro Auth:", error);
                this.els.statusDB.innerText = "Nuvem: Erro üî¥";
                this.mostrarAlerta("Erro ao conectar na nuvem: " + error.message, "Erro");
                return;
            }
            
            const hoje = new Date();
            this.els.dateFilter.value = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
            await this.carregarModelosIA();
            this.iniciarCamera('main');
        },

        // --- SISTEMA DE ALERTAS (COM SUPORTE A ESTILO DE ERRO) ---
        mostrarAlerta: function(msg, titulo = "Aviso", tipo = "normal") {
            const card = this.els.modalAlert.querySelector('.modal-card');
            
            // Reseta estilo
            card.classList.remove('error-style');
            
            // Aplica estilo de erro se solicitado
            if (tipo === "error") {
                card.classList.add('error-style');
            }

            document.getElementById('alert-title').innerText = titulo;
            document.getElementById('alert-msg').innerText = msg;
            this.els.modalAlert.classList.add('active');
        },
        fecharAlert: function() {
            this.els.modalAlert.classList.remove('active');
        },
        mostrarConfirmacao: function(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            this.confirmCallback = callback;
            this.els.modalConfirm.classList.add('active');
            
            const btnYes = document.getElementById('confirm-yes');
            const newBtn = btnYes.cloneNode(true);
            btnYes.parentNode.replaceChild(newBtn, btnYes);
            
            newBtn.addEventListener('click', () => {
                if (this.confirmCallback) this.confirmCallback();
                this.fecharConfirm();
            });
        },
        fecharConfirm: function() {
            this.els.modalConfirm.classList.remove('active');
            this.confirmCallback = null;
        },

        // --- SINCRONIZA√á√ÉO ---
        sincronizarFuncionarios: function() {
            const q = query(collection(db, USERS_COLLECTION));
            onSnapshot(q, (querySnapshot) => {
                this.funcionariosCache = [];
                const labeledDescriptors = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.descriptor) {
                        const values = Object.values(data.descriptor);
                        const floatArray = new Float32Array(values);
                        data.descriptor = floatArray;
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(data.id.toString(), [floatArray]));
                    }
                    this.funcionariosCache.push({ docId: doc.id, ...data });
                });

                if (labeledDescriptors.length > 0) {
                    this.faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
                    console.log("IA Atualizada com", labeledDescriptors.length, "faces.");
                }

                this.atualizarFiltrosUnidade();
                if(document.getElementById('view-admin').style.display === 'block') {
                    this.renderizarListaFuncionarios();
                }
            });
        },

        // --- IA E C√ÇMERA ---
        carregarModelosIA: async function() {
            this.els.statusIA.innerText = "IA: Baixando...";
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.ssdMobilenetv1.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
                ]);
                this.modelosCarregados = true;
                this.els.statusIA.innerText = "IA: Online üü¢";
                this.els.statusIA.classList.add('ready');
                this.iniciarDeteccaoContinua();
            } catch (e) { console.error(e); this.els.statusIA.innerText = "IA: Erro üî¥"; }
        },

        iniciarCamera: async function(tipo) {
            if (this.streamAtiva) this.streamAtiva.getTracks().forEach(track => track.stop());
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                this.streamAtiva = stream;
                if (tipo === 'main') {
                    this.els.videoMain.srcObject = stream;
                    this.els.videoAdmin.srcObject = null;
                } else {
                    this.els.videoAdmin.srcObject = stream;
                    this.els.videoMain.srcObject = null;
                }
            } catch (e) { console.error("Erro Cam", e); }
        },

        iniciarDeteccaoContinua: function() {
            // OTIMIZA√á√ÉO DE VELOCIDADE
            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });

            const loop = async () => {
                if (this.modelosCarregados && 
                    !this.els.videoMain.paused && 
                    this.els.videoMain.srcObject !== null && 
                    this.faceMatcher && 
                    document.getElementById('view-ponto').style.display !== 'none') {

                    try {
                        const detections = await faceapi.detectAllFaces(this.els.videoMain, options)
                            .withFaceLandmarks()
                            .withFaceDescriptors();

                        const dims = faceapi.matchDimensions(this.els.overlay, this.els.videoMain, true);
                        const resized = faceapi.resizeResults(detections, dims);
                        
                        const ctx = this.els.overlay.getContext('2d');
                        ctx.clearRect(0, 0, this.els.overlay.width, this.els.overlay.height);

                        resized.forEach(detection => {
                            const match = this.faceMatcher.findBestMatch(detection.descriptor);
                            const box = detection.detection.box;
                            
                            if (match.label !== 'unknown') {
                                const label = match.label;
                                new faceapi.draw.DrawBox(box, { label: label, boxColor: '#00ff00' }).draw(this.els.overlay);
                                this.processarReconhecimento(label);
                            } else {
                                new faceapi.draw.DrawBox(box, { label: "Desconhecido", boxColor: '#ff0000' }).draw(this.els.overlay);
                            }
                        });
                    } catch (err) { }
                }
                requestAnimationFrame(loop);
            };
            loop();
        },

        processarReconhecimento: function(id) {
            const agora = Date.now();
            if (agora - this.ultimoRegistro < 10000) return; 

            this.els.employeeIdInput.value = id;
            const func = this.funcionariosCache.find(u => u.id == id);
            if (func) {
                this.ultimoRegistro = agora; 
                this.registrarPontoNuvem(func, true); 
            }
        },

        validarPonto: async function() {
            const idDigitado = document.getElementById('employee-id').value;
            if (!idDigitado) return this.mostrarAlerta("Digite o ID.");

            const func = this.funcionariosCache.find(u => u.id == idDigitado);
            if (!func) return this.mostrarAlerta("ID n√£o encontrado.");

            const detection = await faceapi.detectSingleFace(this.els.videoMain, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (!detection) return this.mostrarAlerta("Aproxime o rosto.");

            const distance = faceapi.euclideanDistance(detection.descriptor, func.descriptor);
            
            if (distance < 0.5) {
                this.registrarPontoNuvem(func);
            } else {
                this.mostrarAlerta(`Acesso Negado. Rosto n√£o confere com ${func.nome}`);
            }
        },

        registrarPontoNuvem: async function(func, automatico = false) {
            const tipo = document.getElementById('punch-type').value;
            const agora = new Date();
            const dataHoje = agora.toLocaleDateString('pt-BR');
            const mesAno = `${agora.getFullYear()}-${String(agora.getMonth() + 1).padStart(2, '0')}`;
            
            // VERIFICA DUPLICIDADE
            try {
                const q = query(collection(db, LOGS_COLLECTION), 
                    where("id", "==", func.id),
                    where("data", "==", dataHoje),
                    where("tipo", "==", tipo)
                );
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    // Se for modo MANUAL, abre a janela vermelha grande
                    if (!automatico) {
                        this.mostrarAlerta("Per√≠odo de registro duplicado. Este ponto j√° foi batido hoje.", "‚ö†Ô∏è Aten√ß√£o", "error");
                    } else {
                        // Se for AUTO, apenas mostra o overlay r√°pido para n√£o travar o fluxo
                        this.mostrarErro(`‚ö†Ô∏è ${tipo} duplicado!`);
                    }
                    return; // Interrompe o registro
                }
            } catch (err) { console.error(err); }

            const ctx = this.els.canvas.getContext('2d');
            this.els.canvas.width = this.els.videoMain.videoWidth;
            this.els.canvas.height = this.els.videoMain.videoHeight;
            ctx.drawImage(this.els.videoMain, 0, 0);
            const foto = this.els.canvas.toDataURL('image/jpeg', 0.3); 

            try {
                await addDoc(collection(db, LOGS_COLLECTION), {
                    timestamp: agora.getTime(),
                    id: func.id,
                    nome: func.nome,
                    unidade: func.unidade,
                    tipo: tipo,
                    data: dataHoje,
                    hora: agora.toLocaleTimeString('pt-BR'),
                    mesAno: mesAno,
                    foto: foto,
                    modo: automatico ? "Auto IA" : "Manual"
                });
                this.mostrarSucesso(`Ponto Registrado!\n${func.nome} - ${tipo}`);
                document.getElementById('employee-id').value = '';
            } catch (e) { console.error(e); }
        },

        mostrarSucesso: function(texto) {
            this.els.successText.innerText = texto;
            this.els.successMessage.style.display = "block";
            setTimeout(() => { this.els.successMessage.style.display = "none"; }, 3000);
        },
        mostrarErro: function(texto) {
            this.els.errorText.innerText = texto;
            this.els.errorMessage.style.display = "block";
            setTimeout(() => { this.els.errorMessage.style.display = "none"; }, 3000);
        },

        // --- CADASTRO ---
        cadastrarBiometria: async function() {
            if (!this.modelosCarregados) return this.mostrarAlerta("Aguarde a IA...");
            const id = document.getElementById('new-user-id').value;
            const nome = document.getElementById('new-user-name').value;
            const unidade = document.getElementById('new-user-unit').value;
            const horas = document.getElementById('new-user-hours').value;

            if (!id || !nome || !unidade) return this.mostrarAlerta("Preencha todos os campos.");
            if (this.funcionariosCache.find(u => u.id == id)) return this.mostrarAlerta("ID j√° existe!");

            const detection = await faceapi.detectSingleFace(this.els.videoAdmin, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
            if (!detection) return this.mostrarAlerta("Rosto n√£o detectado!");

            const descriptorObj = { ...detection.descriptor }; 
            
            try {
                await addDoc(collection(db, USERS_COLLECTION), {
                    id: id, nome: nome, unidade: unidade, horasSemanais: horas, descriptor: descriptorObj
                });
                this.mostrarAlerta("Cadastrado com Sucesso!", "Sucesso");
                document.getElementById('new-user-id').value = '';
                document.getElementById('new-user-name').value = '';
            } catch (e) { this.mostrarAlerta("Erro ao salvar: " + e.message, "Erro"); }
        },

        // --- GEST√ÉO ---
        renderizarListaFuncionarios: function() {
            const tbody = document.getElementById('employees-tbody');
            const filterUnit = this.els.employeesUnitFilter.value;
            let lista = this.funcionariosCache;
            if (filterUnit) lista = lista.filter(u => u.unidade === filterUnit);
            tbody.innerHTML = '';
            lista.forEach(u => {
                tbody.innerHTML += `<tr><td>${u.id}</td><td>${u.nome}</td><td>${u.unidade}</td><td>${u.horasSemanais}h</td>
                <td><button class="btn-edit" onclick="window.app.abrirEdicao('${u.id}')">‚úèÔ∏è</button>
                <button class="btn-danger small" onclick="window.app.excluirUsuario('${u.docId}')">üóëÔ∏è</button></td></tr>`;
            });
        },
        excluirUsuario: async function(docId) {
            this.mostrarConfirmacao("Excluir permanentemente?", async () => {
                try { await deleteDoc(doc(db, USERS_COLLECTION, docId)); this.mostrarAlerta("Exclu√≠do.", "Sucesso"); } catch (e) { this.mostrarAlerta(e.message, "Erro"); }
            });
        },
        abrirEdicao: function(id) {
            const user = this.funcionariosCache.find(u => u.id == id);
            if (!user) return;
            document.getElementById('edit-user-id-hidden').value = user.docId;
            document.getElementById('edit-user-name').value = user.nome;
            document.getElementById('edit-user-unit').value = user.unidade;
            document.getElementById('edit-user-hours').value = user.horasSemanais;
            this.els.modalEdit.classList.add('active');
        },
        salvarEdicao: async function() {
            const docId = document.getElementById('edit-user-id-hidden').value;
            try { await updateDoc(doc(db, USERS_COLLECTION, docId), { nome: document.getElementById('edit-user-name').value, unidade: document.getElementById('edit-user-unit').value, horasSemanais: document.getElementById('edit-user-hours').value }); this.mostrarAlerta("Atualizado!", "Sucesso"); this.els.modalEdit.classList.remove('active'); } catch (e) { this.mostrarAlerta(e.message, "Erro"); }
        },
        carregarTabelaPontos: async function() {
            const mes = this.els.dateFilter.value;
            if(!mes) return this.mostrarAlerta("Escolha o m√™s.");
            const tbody = document.getElementById('logs-tbody');
            tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
            const q = query(collection(db, LOGS_COLLECTION), where("mesAno", "==", mes));
            const snapshot = await getDocs(q);
            let dados = []; snapshot.forEach(doc => dados.push(doc.data()));
            const unid = document.getElementById('admin-unit-filter').value;
            if(unid) dados = dados.filter(d => d.unidade === unid);
            dados.sort((a,b) => b.timestamp - a.timestamp);
            tbody.innerHTML = '';
            if (dados.length === 0) { tbody.innerHTML = '<tr><td colspan="6">Vazio.</td></tr>'; return; }
            dados.forEach(r => tbody.innerHTML += `<tr><td>${r.data}</td><td>${r.hora}</td><td>${r.id}</td><td>${r.nome}</td><td>${r.unidade}</td><td>${r.tipo}</td></tr>`);
        },

        // --- RELAT√ìRIOS ---
        mesPorExtenso: function(anoMesStr) {
            if (!anoMesStr) return "";
            const [ano, mes] = anoMesStr.split('-');
            const dataObj = new Date(parseInt(ano), parseInt(mes) - 1, 1);
            const mesExtenso = dataObj.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            return mesExtenso.charAt(0).toUpperCase() + mesExtenso.slice(1);
        },

        gerarRelatorioImpresso: function(titulo, colunas, linhasHTML) {
            const janela = window.open('', '_blank');
            const dataHoje = new Date().toLocaleDateString('pt-BR');
            const conteudo = `<html><head><title>${titulo}</title><style>body{font-family:'Times New Roman';padding:40px;}.header{text-align:center;border-bottom:2px solid #1e3a8a;padding-bottom:20px;}.logo-text{font-size:24pt;font-weight:bold;color:#1e3a8a;display:block;}table{width:100%;border-collapse:collapse;margin-top:20px;font-size:10pt;font-family:Arial;}th,td{border:1px solid #000;padding:6px;text-align:center;}th{background-color:#e0e0e0;}.footer{position:fixed;bottom:0;width:100%;text-align:center;font-size:9pt;border-top:1px solid #ccc;padding-top:10px;}</style></head><body><div class="header"><span class="logo-text">Maranath√°</span><h1>${COMPANY_INFO.nome}</h1><p>${COMPANY_INFO.endereco}</p><p>${COMPANY_INFO.cnpj_site}</p></div><h2 style="text-align:center">${titulo}</h2><p style="text-align:right">Emiss√£o: ${dataHoje}</p><table><thead><tr>${colunas.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${linhasHTML}</tbody></table><div class="footer">${COMPANY_INFO.nome}</div><script>window.onload=function(){window.print()}<\/script></body></html>`;
            janela.document.write(conteudo); janela.document.close();
        },
        imprimirRelatorioDetalhado: async function() {
            const mesVal = this.els.dateFilter.value;
            const mesExtenso = this.mesPorExtenso(mesVal);
            const unid = document.getElementById('admin-unit-filter').value;
            const q = query(collection(db, LOGS_COLLECTION), where("mesAno", "==", mesVal));
            const snapshot = await getDocs(q);
            let dados = []; snapshot.forEach(doc => dados.push(doc.data()));
            if(unid) dados = dados.filter(d => d.unidade === unid);
            dados.sort((a,b) => a.timestamp - b.timestamp);
            if(dados.length === 0) return this.mostrarAlerta("Sem dados.");
            let linhasHTML = dados.map(r => `<tr><td>${r.data}</td><td>${r.hora}</td><td>${r.id}</td><td>${r.nome}</td><td>${r.unidade}</td><td>${r.tipo}</td></tr>`).join('');
            this.gerarRelatorioImpresso(`Extrato Detalhado - ${mesExtenso}`, ["Data", "Hora", "ID", "Nome", "Unidade", "Tipo"], linhasHTML);
        },
        imprimirRelatorioFechamento: async function() {
            const mesVal = this.els.dateFilter.value;
            const mesExtenso = this.mesPorExtenso(mesVal);
            if(!mesVal) return this.mostrarAlerta("Selecione um m√™s.");
            const q = query(collection(db, LOGS_COLLECTION), where("mesAno", "==", mesVal));
            const snapshot = await getDocs(q);
            const registros = []; snapshot.forEach(doc => registros.push(doc.data()));
            if(registros.length === 0) return this.mostrarAlerta("Sem dados.");
            const resumo = {};
            this.funcionariosCache.forEach(f => { resumo[f.id] = { nome: f.nome, unidade: f.unidade, carga: parseFloat(f.horasSemanais || 44), dias: new Set(), pontos: {} }; });
            registros.forEach(r => {
                if(resumo[r.id]) {
                    resumo[r.id].dias.add(r.data);
                    if(!resumo[r.id].pontos[r.data]) resumo[r.id].pontos[r.data] = [];
                    const [h, m] = r.hora.split(':').map(Number);
                    resumo[r.id].pontos[r.data].push(h * 60 + m);
                }
            });
            let linhasHTML = "";
            Object.keys(resumo).forEach(id => {
                const f = resumo[id];
                let minTotais = 0;
                Object.values(f.pontos).forEach(batidas => {
                    batidas.sort((a,b) => a - b);
                    for(let i = 0; i < batidas.length - 1; i += 2) minTotais += (batidas[i+1] - batidas[i]);
                });
                const horasTrab = (minTotais / 60).toFixed(2);
                const cargaMensal = ((f.carga / 6) * 30).toFixed(2);
                const saldo = (horasTrab - cargaMensal).toFixed(2);
                const corSaldo = saldo < 0 ? "red" : "green";
                linhasHTML += `<tr><td>${id}</td><td>${f.nome}</td><td>${f.unidade}</td><td>${f.carga}h</td><td>${f.dias.size}</td><td>${horasTrab}h</td><td>${cargaMensal}h</td><td style="color:${corSaldo}">${saldo}h</td></tr>`;
            });
            this.gerarRelatorioImpresso(`Fechamento Mensal - ${mesExtenso}`, ["ID", "Nome", "Unidade", "Meta", "Dias", "Trab", "Esperado", "Saldo"], linhasHTML);
        },

        atualizarFiltrosUnidade: function() {
            const unidades = [...new Set(this.funcionariosCache.map(f => f.unidade))];
            const opts = '<option value="">Todas</option>' + unidades.map(u => `<option value="${u}">${u}</option>`).join('');
            this.els.unitFilter.innerHTML = opts; this.els.employeesUnitFilter.innerHTML = opts;
        },
        switchTab: function(tab) {
            if(tab === 'admin' && !this.adminLogado) { this.els.modalLogin.classList.add('active'); return; }
            if(tab !== 'admin') this.adminLogado = false; 
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            if (tab === 'admin') { this.iniciarCamera('admin'); this.renderizarListaFuncionarios(); } else { this.iniciarCamera('main'); }
        },
        verificarLogin: function() {
            if (document.getElementById('login-user').value === this.adminConfig.user && document.getElementById('login-pass').value === this.adminConfig.pass) {
                this.adminLogado = true; this.els.modalLogin.classList.remove('active'); document.getElementById('login-user').value = ''; document.getElementById('login-pass').value = ''; this.switchTab('admin');
            } else { this.mostrarAlerta("Senha incorreta", "Erro"); }
        },
        fecharLogin: function() { this.els.modalLogin.classList.remove('active'); },
        logoutAdmin: function() { this.adminLogado = false; this.switchTab('ponto'); },
    };

    window.app = app;
    document.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>